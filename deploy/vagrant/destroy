#!/bin/bash

set -e

cd $(dirname $0)
if [[ -f conf/ec2.yml && "$(python bin/is_aws_spot.py)" == "0" ]]; then
  python bin/spot_request.py --cancel
else
  vagrant destroy -f
fi

if grep -Fq "# Generated by Tachyon vagrant deploy script" /etc/hosts
then
  echo "Remove Tachyon IP Alias from /etc/hosts..."
  sudo "$BASH" -c "sed -i '/^# Generated by Tachyon vagrant deploy script/d' /etc/hosts"
  sudo "$BASH" -c "sed -i '/^Tachyon.*$/d' /etc/hosts"
fi

TACHYON_BOX=$(vagrant box list | grep tachyon-dev | cut -d ' ' -f1)
if [[ "$TACHYON_BOX" != '' ]]; then
  echo "Vagrant VMs are removed sucesfully."
  echo "If you want to remove base vm image $TACHYON_BOX, please run: vagrant box remove $TACHYON_BOX"
fi

