# -*- mode: ruby -*-
# vi: set ft=ruby :

require 'yaml'

@cmd = YAML.load_file('init.yml')
puts @cmd.inspect

Ufs = @cmd['Ufs']
Total = @cmd['Total']
Provider = @cmd['Provider']
Memory = @cmd['Memory']
Addr = @cmd['Addresses']
Init = "#{Ufs}"+"/init.sh"
Post = "#{Ufs}"+"/post.sh"

# Vagrantfile API/syntax version. 
VAGRANTFILE_API_VERSION = "2"
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  (1..Total).each do |i|    
    # multi vm config
    name = ""
    if i == Total 
      name = "TachyonMaster"
    else
      name = "TachyonSlave#{i}"
    end
    config.vm.define "#{name}" do |n|
      # common config
      n.vm.provision "shell", path: "init.sh"
      n.vm.provision "shell", path: Init
      n.vm.synced_folder "../../", "/tachyon"
      n.vm.synced_folder "./", "/vagrant"

      # files shared by VMs go into shared folder
      system 'mkdir', '-p', './shared'

      # config cluster
      if i == 1
        file = File.open("../../conf/slaves","w")
      else
        file = File.open("../../conf/slaves","a")
      end
      if file != nil
        file.write(Addr[i - 1])
        file.write("\n")
      end
      file.close unless file == nil

      # Provider specific init
      if Provider == "vb"
        n.vm.box = "chef/centos-6.5"
        n.vm.provider "virtualbox" do |vb|
          if Memory != ''
            vb.customize ["modifyvm", :id, "--memory", Memory]
          end
          vb.gui = true
          eval File.open('config_vb.rb').read
          config_vb(n, i, Total, name)
        end
      end
    end
  end
end
