<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
 | Generated by Apache Maven Doxia at 2018-04-16
 | Rendered using Apache Maven Stylus Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Apache Hadoop Amazon Web Services support &#x2013; Testing the Hadoop S3 filesystem clients</title>
    <style type="text/css" media="all">
      @import url("../../css/maven-base.css");
      @import url("../../css/maven-theme.css");
      @import url("../../css/site.css");
    </style>
    <link rel="stylesheet" href="../../css/print.css" type="text/css" media="print" />
        <meta name="Date-Revision-yyyymmdd" content="20180416" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
                </head>
  <body class="composite">
    <div id="banner">
                        <a href="http://hadoop.apache.org/" id="bannerLeft">
                                        <img src="http://hadoop.apache.org/images/hadoop-logo.jpg" alt="" />
                </a>
                              <a href="http://www.apache.org/" id="bannerRight">
                                        <img src="http://www.apache.org/images/asf_logo_wide.png" alt="" />
                </a>
            <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                                   <div class="xleft">
                          <a href="http://www.apache.org/" class="externalLink">Apache</a>
        &gt;
                  <a href="http://hadoop.apache.org/" class="externalLink">Hadoop</a>
        &gt;
                  <a href="../../index.html">Apache Hadoop Amazon Web Services support</a>
        &gt;
        Testing the Hadoop S3 filesystem clients
        </div>
            <div class="xright">            <a href="http://wiki.apache.org/hadoop" class="externalLink">Wiki</a>
            |
                <a href="https://git-wip-us.apache.org/repos/asf/hadoop.git" class="externalLink">git</a>
              
                                   &nbsp;| Last Published: 2018-04-16
              &nbsp;| Version: 2.9.1
            </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                                                   <h5>General</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../index.html">Overview</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/SingleCluster.html">Single Node Setup</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/ClusterSetup.html">Cluster Setup</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/CommandsManual.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/FileSystemShell.html">FileSystem Shell</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Compatibility.html">Hadoop Compatibility</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/InterfaceClassification.html">Interface Classification</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/filesystem/index.html">FileSystem Specification</a>
            </li>
          </ul>
                       <h5>Common</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/CLIMiniCluster.html">CLI Mini Cluster</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/NativeLibraries.html">Native Libraries</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Superusers.html">Proxy User</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/RackAwareness.html">Rack Awareness</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/SecureMode.html">Secure Mode</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/ServiceLevelAuth.html">Service Level Authorization</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/HttpAuthentication.html">HTTP Authentication</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/CredentialProviderAPI.html">Credential Provider API</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-kms/index.html">Hadoop KMS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Tracing.html">Tracing</a>
            </li>
          </ul>
                       <h5>HDFS</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsDesign.html">Architecture</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsUserGuide.html">User Guide</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSCommands.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSHighAvailabilityWithQJM.html">NameNode HA With QJM</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSHighAvailabilityWithNFS.html">NameNode HA With NFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/Federation.html">Federation</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ViewFs.html">ViewFs</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsSnapshots.html">Snapshots</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsEditsViewer.html">Edits Viewer</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsImageViewer.html">Image Viewer</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html">Permissions and HDFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsQuotaAdminGuide.html">Quotas and HDFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/Hftp.html">HFTP</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/LibHdfs.html">libhdfs (C API)</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/WebHDFS.html">WebHDFS (REST API)</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-hdfs-httpfs/index.html">HttpFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ShortCircuitLocalReads.html">Short Circuit Local Reads</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/CentralizedCacheManagement.html">Centralized Cache Management</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsNfsGateway.html">NFS Gateway</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsRollingUpgrade.html">Rolling Upgrade</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ExtendedAttributes.html">Extended Attributes</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/TransparentEncryption.html">Transparent Encryption</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsMultihoming.html">Multihoming</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ArchivalStorage.html">Storage Policies</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/MemoryStorage.html">Memory Storage Support</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsUpgradeDomain.html">Upgrade Domain</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsDataNodeAdminGuide.html">DataNode Admin</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs-rbf/HDFSRouterFederation.html">Router Federation</a>
            </li>
          </ul>
                       <h5>MapReduce</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduceTutorial.html">Tutorial</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapredCommands.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduce_Compatibility_Hadoop1_Hadoop2.html">Compatibility with 1.x</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/EncryptedShuffle.html">Encrypted Shuffle</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/PluggableShuffleAndPluggableSort.html">Pluggable Shuffle/Sort</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/DistributedCacheDeploy.html">Distributed Cache Deploy</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/SharedCacheSupport.html">Support for YARN Shared Cache</a>
            </li>
          </ul>
                       <h5>MapReduce REST APIs</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapredAppMasterRest.html">MR Application Master</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-hs/HistoryServerRest.html">MR History Server</a>
            </li>
          </ul>
                       <h5>YARN</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/YARN.html">Architecture</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/YarnCommands.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/CapacityScheduler.html">Capacity Scheduler</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/FairScheduler.html">Fair Scheduler</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ResourceManagerRestart.html">ResourceManager Restart</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ResourceManagerHA.html">ResourceManager HA</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeLabel.html">Node Labels</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/WebApplicationProxy.html">Web Application Proxy</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServer.html">Timeline Server</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServiceV2.html">Timeline Service V.2</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/WritingYarnApplications.html">Writing YARN Applications</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/YarnApplicationSecurity.html">YARN Application Security</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeManager.html">NodeManager</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/DockerContainerExecutor.html">DockerContainerExecutor</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/DockerContainers.html">Running Applications in Docker Containers</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeManagerCgroups.html">Using CGroups</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/SecureContainer.html">Secure Containers</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/registry/index.html">Registry</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ReservationSystem.html">Reservation System</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/GracefulDecommission.html">Graceful Decommission</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/OpportunisticContainers.html">Opportunistic Containers</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/Federation.html">YARN Federation</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/SharedCache.html">Shared Cache</a>
            </li>
          </ul>
                       <h5>YARN REST APIs</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/WebServicesIntro.html">Introduction</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ResourceManagerRest.html">Resource Manager</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeManagerRest.html">Node Manager</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServer.html#Timeline_Server_REST_API_v1">Timeline Server</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServiceV2.html#Timeline_Service_v.2_REST_API">Timeline Service V.2</a>
            </li>
          </ul>
                       <h5>Hadoop Compatible File Systems</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-aws/tools/hadoop-aws/index.html">Amazon S3</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-azure/index.html">Azure Blob Storage</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-openstack/index.html">OpenStack Swift</a>
            </li>
          </ul>
                       <h5>Auth</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-auth/index.html">Overview</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-auth/Examples.html">Examples</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-auth/Configuration.html">Configuration</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-auth/BuildingIt.html">Building</a>
            </li>
          </ul>
                       <h5>Tools</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-streaming/HadoopStreaming.html">Hadoop Streaming</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-archives/HadoopArchives.html">Hadoop Archives</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-archive-logs/HadoopArchiveLogs.html">Hadoop Archive Logs</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-distcp/DistCp.html">DistCp</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-gridmix/GridMix.html">GridMix</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-rumen/Rumen.html">Rumen</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-resourceestimator/ResourceEstimator.html">Resource Estimator Service</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-sls/SchedulerLoadSimulator.html">Scheduler Load Simulator</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Benchmarking.html">Hadoop Benchmarking</a>
            </li>
          </ul>
                       <h5>Reference</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/release/index.html">Changelog and Release Notes</a>
            </li>
                  <li class="none">
                  <a href="../../../api/index.html">API docs</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Metrics.html">Metrics</a>
            </li>
          </ul>
                       <h5>Configuration</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/core-default.xml">core-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/hdfs-default.xml">hdfs-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/mapred-default.xml">mapred-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-common/yarn-default.xml">yarn-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/DeprecatedProperties.html">Deprecated Properties</a>
            </li>
          </ul>
                                 <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
          <img alt="Built by Maven" src="../../images/logos/maven-feather.png"/>
        </a>
                       
                               </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <!---
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. See accompanying LICENSE file.
--><h1>Testing the Hadoop S3 filesystem clients</h1>

<ul>
<li><a href="#Policy_for_submitting_patches_which_affect_the_hadoop-aws_module.">Policy for submitting patches which affect the hadoop-aws module.</a>
<ul>
<li><a href="#The_submitter_of_any_patch_is_required_to_run_all_the_integration_tests_and_declare_which_S3_regionimplementation_they_used.">The submitter of any patch is required to run all the integration tests and declare which S3 region/implementation they used.</a></li>
<li><a href="#What_if_theres_an_intermittent_failure_of_a_test">What if there&#x2019;s an intermittent failure of a test?</a></li>
<li><a href="#What_if_the_tests_are_timing_out_or_failing_over_my_network_connection">What if the tests are timing out or failing over my network connection?</a></li></ul></li>
<li><a href="#Setting_up_the_tests">Setting up the tests</a>
<ul>
<li><a href="#File_core-site.xml">File core-site.xml</a></li>
<li><a href="#File_auth-keys.xml">File auth-keys.xml</a></li>
<li><a href="#Configuring_S3a_Encryption">Configuring S3a Encryption</a></li></ul></li>
<li><a href="#Running_the_Tests">Running the Tests</a>
<ul>
<li><a href="#Testing_against_different_regions">Testing against different regions</a></li>
<li><a href="#CSV_Data_source_Tests">CSV Data source Tests</a></li>
<li><a href="#Viewing_Integration_Test_Reports">Viewing Integration Test Reports</a></li>
<li><a href="#Scale_Tests">Scale Tests</a>
<ul>
<li><a href="#Enabling_the_Scale_Tests">Enabling the Scale Tests</a></li>
<li><a href="#Maven_build_tuning_options">Maven build tuning options</a></li>
<li><a href="#Scale_test_configuration_options">Scale test configuration options</a>
<ul>
<li><a href="#fs.s3a.scale.test.huge.filesize:_size_in_MB_for_Huge_file_tests.">fs.s3a.scale.test.huge.filesize: size in MB for &#x201c;Huge file tests&#x201d;.</a></li></ul></li></ul></li></ul></li>
<li><a href="#Testing_against_non_AWS_S3_endpoints.">Testing against non AWS S3 endpoints.</a>
<ul>
<li><a href="#Disabling_the_encryption_tests">Disabling the encryption tests</a></li>
<li><a href="#Configuring_the_CSV_file_read_tests">Configuring the CSV file read tests**</a></li>
<li><a href="#Testing_Session_Credentials">Testing Session Credentials</a></li></ul></li>
<li><a href="#Debugging_Test_failures">Debugging Test failures</a></li>
<li><a href="#Adding_new_tests">Adding new tests</a>
<ul>
<li><a href="#Requirements_of_new_Tests">Requirements of new Tests</a>
<ul>
<li><a href="#Subclasses_Existing_Shared_Base_Classes">Subclasses Existing Shared Base Classes</a></li>
<li><a href="#Secure">Secure</a></li>
<li><a href="#Efficient_of_Time_and_Money">Efficient of Time and Money</a></li>
<li><a href="#Works_With_Other_S3_Endpoints">Works With Other S3 Endpoints</a></li></ul></li>
<li><a href="#Works_Over_Long-haul_Links">Works Over Long-haul Links</a></li>
<li><a href="#Provides_Diagnostics_and_timing_information">Provides Diagnostics and timing information</a>
<ul>
<li><a href="#Fails_Meaningfully">Fails Meaningfully</a></li></ul></li>
<li><a href="#Cleans_Up_Afterwards">Cleans Up Afterwards</a></li>
<li><a href="#Works_Reliably">Works Reliably</a></li></ul></li>
<li><a href="#Testing_s3:">Testing s3://</a>
<ul>
<li><a href="#s3:">s3://</a></li></ul></li>
<li><a href="#Tips">Tips</a>
<ul>
<li><a href="#How_to_keep_your_credentials_really_safe">How to keep your credentials really safe</a></li></ul></li>
<li><a href="#Simulating_List_Inconsistencies">Simulating List Inconsistencies</a>
<ul>
<li><a href="#Enabling_the_InconsistentAmazonS3CClient">Enabling the InconsistentAmazonS3CClient</a></li>
<li><a href="#Limitations_of_Inconsistency_Injection">Limitations of Inconsistency Injection</a></li>
<li><a href="#Using_the_InconsistentAmazonS3CClient_in_downstream_integration_tests">Using the InconsistentAmazonS3CClient in downstream integration tests</a></li></ul></li>
<li><a href="#Testing_S3Guard">Testing S3Guard</a></li>
<li><a href="#Testing_S3A_with_S3Guard_Enabled">Testing S3A with S3Guard Enabled</a>
<ul>
<li><a href="#Notes">Notes</a></li>
<li><a href="#Warning_About_Concurrent_Tests">Warning About Concurrent Tests</a></li>
<li><a href="#Scale_Testing_MetadataStore_Directly">Scale Testing MetadataStore Directly</a></li>
<li><a href="#Testing_only:_Local_Metadata_Store">Testing only: Local Metadata Store</a></li></ul></li></ul>
<p>This module includes both unit tests, which can run in isolation without connecting to the S3 service, and integration tests, which require a working connection to S3 to interact with a bucket. Unit test suites follow the naming convention <tt>Test*.java</tt>. Integration tests follow the naming convention <tt>ITest*.java</tt>.</p>
<p>Due to eventual consistency, integration tests may fail without reason. Transient failures, which no longer occur upon rerunning the test, should thus be ignored.</p>
<div class="section">
<h2><a name="Policy_for_submitting_patches_which_affect_the_hadoop-aws_module."></a>Policy for submitting patches which affect the <tt>hadoop-aws</tt> module.</h2>
<p>The Apache Jenkins infrastucture does not run any S3 integration tests, due to the need to keep credentials secure.</p>
<div class="section">
<h3><a name="The_submitter_of_any_patch_is_required_to_run_all_the_integration_tests_and_declare_which_S3_regionimplementation_they_used."></a>The submitter of any patch is required to run all the integration tests and declare which S3 region/implementation they used.</h3>
<p>This is important: <b>patches which do not include this declaration will be ignored</b></p>
<p>This policy has proven to be the only mechanism to guarantee full regression testing of code changes. Why the declaration of region? Two reasons</p>

<ol style="list-style-type: decimal">
  
<li>It helps us identify regressions which only surface against specific endpoints or third-party implementations of the S3 protocol.</li>
  
<li>It forces the submitters to be more honest about their testing. It&#x2019;s easy to lie, &#x201c;yes, I tested this&#x201d;. To say &#x201c;yes, I tested this against S3 US-west&#x201d; is a more specific lie and harder to make. And, if you get caught out: you lose all credibility with the project.</li>
</ol>
<p>You don&#x2019;t need to test from a VM within the AWS infrastructure; with the <tt>-Dparallel=tests</tt> option the non-scale tests complete in under ten minutes. Because the tests clean up after themselves, they are also designed to be low cost. It&#x2019;s neither hard nor expensive to run the tests; if you can&#x2019;t, there&#x2019;s no guarantee your patch works. The reviewers have enough to do, and don&#x2019;t have the time to do these tests, especially as every failure will simply make for a slow iterative development.</p>
<p>Please: run the tests. And if you don&#x2019;t, we are sorry for declining your patch, but we have to.</p></div>
<div class="section">
<h3><a name="What_if_theres_an_intermittent_failure_of_a_test"></a>What if there&#x2019;s an intermittent failure of a test?</h3>
<p>Some of the tests do fail intermittently, especially in parallel runs. If this happens, try to run the test on its own to see if the test succeeds.</p>
<p>If it still fails, include this fact in your declaration. We know some tests are intermittently unreliable.</p></div>
<div class="section">
<h3><a name="What_if_the_tests_are_timing_out_or_failing_over_my_network_connection"></a>What if the tests are timing out or failing over my network connection?</h3>
<p>The tests and the S3A client are designed to be configurable for different timeouts. If you are seeing problems and this configuration isn&#x2019;t working, that&#x2019;s a sign of the configuration mechanism isn&#x2019;t complete. If it&#x2019;s happening in the production code, that could be a sign of a problem which may surface over long-haul connections. Please help us identify and fix these problems &#x2014; especially as you are the one best placed to verify the fixes work.</p></div></div>
<div class="section">
<h2><a name="Setting_up_the_tests"></a>Setting up the tests</h2>
<p>To integration test the S3* filesystem clients, you need to provide <tt>auth-keys.xml</tt> which passes in authentication details to the test runner.</p>
<p>It is a Hadoop XML configuration file, which must be placed into <tt>hadoop-tools/hadoop-aws/src/test/resources</tt>.</p>
<div class="section">
<h3><a name="File_core-site.xml"></a>File <tt>core-site.xml</tt></h3>
<p>This file pre-exists and sources the configurations created under <tt>auth-keys.xml</tt>.</p>
<p>For most purposes you will not need to edit this file unless you need to apply a specific, non-default property change during the tests.</p></div>
<div class="section">
<h3><a name="File_auth-keys.xml"></a>File <tt>auth-keys.xml</tt></h3>
<p>The presence of this file triggers the testing of the S3 classes.</p>
<p>Without this file, <i>none of the integration tests in this module will be executed</i>.</p>
<p>The XML file must contain all the ID/key information needed to connect each of the filesystem clients to the object stores, and a URL for each filesystem for its testing.</p>

<ol style="list-style-type: decimal">
  
<li><tt>test.fs.s3n.name</tt> : the URL of the bucket for S3n tests</li>
  
<li><tt>test.fs.s3a.name</tt> : the URL of the bucket for S3a tests</li>
  
<li><tt>fs.contract.test.fs.s3n</tt> : the URL of the bucket for S3n filesystem contract tests</li>
  
<li><tt>fs.contract.test.fs.s3a</tt> : the URL of the bucket for S3a filesystem contract tests</li>
</ol>
<p><i>Note</i> that running s3a and s3n tests in parallel mode, against the same bucket is unreliable. We recommend using separate buckets or testing one connector at a time.</p>
<p>The contents of each bucket will be destroyed during the test process: do not use the bucket for any purpose other than testing. Furthermore, for s3a, all in-progress multi-part uploads to the bucket will be aborted at the start of a test (by forcing <tt>fs.s3a.multipart.purge=true</tt>) to clean up the temporary state of previously failed tests.</p>
<p>Example:</p>

<div class="source">
<div class="source">
<pre>&lt;configuration&gt;

  &lt;property&gt;
    &lt;name&gt;test.fs.s3n.name&lt;/name&gt;
    &lt;value&gt;s3n://test-aws-s3n/&lt;/value&gt;
  &lt;/property&gt;

  &lt;property&gt;
    &lt;name&gt;fs.contract.test.fs.s3n&lt;/name&gt;
    &lt;value&gt;${test.fs.s3n.name}&lt;/value&gt;
  &lt;/property&gt;

  &lt;property&gt;
    &lt;name&gt;fs.s3n.awsAccessKeyId&lt;/name&gt;
    &lt;value&gt;DONOTPCOMMITTHISKEYTOSCM&lt;/value&gt;
  &lt;/property&gt;

  &lt;property&gt;
    &lt;name&gt;fs.s3n.awsSecretAccessKey&lt;/name&gt;
    &lt;value&gt;DONOTEVERSHARETHISSECRETKEY!&lt;/value&gt;
  &lt;/property&gt;

  &lt;property&gt;
    &lt;name&gt;test.fs.s3a.name&lt;/name&gt;
    &lt;value&gt;s3a://test-aws-s3a/&lt;/value&gt;
  &lt;/property&gt;

  &lt;property&gt;
    &lt;name&gt;fs.contract.test.fs.s3a&lt;/name&gt;
    &lt;value&gt;${test.fs.s3a.name}&lt;/value&gt;
  &lt;/property&gt;

  &lt;property&gt;
    &lt;name&gt;fs.s3a.access.key&lt;/name&gt;
    &lt;description&gt;AWS access key ID. Omit for IAM role-based authentication.&lt;/description&gt;
    &lt;value&gt;DONOTCOMMITTHISKEYTOSCM&lt;/value&gt;
  &lt;/property&gt;

  &lt;property&gt;
    &lt;name&gt;fs.s3a.secret.key&lt;/name&gt;
    &lt;description&gt;AWS secret key. Omit for IAM role-based authentication.&lt;/description&gt;
    &lt;value&gt;DONOTEVERSHARETHISSECRETKEY!&lt;/value&gt;
  &lt;/property&gt;

  &lt;property&gt;
    &lt;name&gt;test.sts.endpoint&lt;/name&gt;
    &lt;description&gt;Specific endpoint to use for STS requests.&lt;/description&gt;
    &lt;value&gt;sts.amazonaws.com&lt;/value&gt;
  &lt;/property&gt;

&lt;/configuration&gt;
</pre></div></div></div>
<div class="section">
<h3><a name="Configuring_S3a_Encryption"></a>Configuring S3a Encryption</h3>
<p>For S3a encryption tests to run correctly, the <tt>fs.s3a.server-side-encryption.key</tt> must be configured in the s3a contract xml file with a AWS KMS encryption key arn as this value is different for each AWS KMS.</p>
<p>Example:</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.server-side-encryption.key&lt;/name&gt;
  &lt;value&gt;arn:aws:kms:us-west-2:360379543683:key/071a86ff-8881-4ba0-9230-95af6d01ca01&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>You can also force all the tests to run with a specific SSE encryption method by configuring the property <tt>fs.s3a.server-side-encryption-algorithm</tt> in the s3a contract file.</p></div></div>
<div class="section">
<h2><a name="Running_the_Tests"></a>Running the Tests</h2>
<p>After completing the configuration, execute the test run through Maven.</p>

<div class="source">
<div class="source">
<pre>mvn clean verify
</pre></div></div>
<p>It&#x2019;s also possible to execute multiple test suites in parallel by passing the <tt>parallel-tests</tt> property on the command line. The tests spend most of their time blocked on network I/O with the S3 service, so running in parallel tends to complete full test runs faster.</p>

<div class="source">
<div class="source">
<pre>mvn -Dparallel-tests clean verify
</pre></div></div>
<p>Some tests must run with exclusive access to the S3 bucket, so even with the <tt>parallel-tests</tt> property, several test suites will run in serial in a separate Maven execution step after the parallel tests.</p>
<p>By default, <tt>parallel-tests</tt> runs 4 test suites concurrently. This can be tuned by passing the <tt>testsThreadCount</tt> property.</p>

<div class="source">
<div class="source">
<pre>mvn -Dparallel-tests -DtestsThreadCount=8 clean verify
</pre></div></div>
<p>To run just unit tests, which do not require S3 connectivity or AWS credentials, use any of the above invocations, but switch the goal to <tt>test</tt> instead of <tt>verify</tt>.</p>

<div class="source">
<div class="source">
<pre>mvn clean test

mvn -Dparallel-tests clean test

mvn -Dparallel-tests -DtestsThreadCount=8 clean test
</pre></div></div>
<p>To run only a specific named subset of tests, pass the <tt>test</tt> property for unit tests or the <tt>it.test</tt> property for integration tests.</p>

<div class="source">
<div class="source">
<pre>mvn clean test -Dtest=TestS3AInputPolicies

mvn clean verify -Dit.test=ITestS3AFileContextStatistics -Dtest=none

mvn clean verify -Dtest=TestS3A* -Dit.test=ITestS3A*
</pre></div></div>
<p>Note that when running a specific subset of tests, the patterns passed in <tt>test</tt> and <tt>it.test</tt> override the configuration of which tests need to run in isolation in a separate serial phase (mentioned above). This can cause unpredictable results, so the recommendation is to avoid passing <tt>parallel-tests</tt> in combination with <tt>test</tt> or <tt>it.test</tt>. If you know that you are specifying only tests that can run safely in parallel, then it will work. For wide patterns, like <tt>ITestS3A*</tt> shown above, it may cause unpredictable test failures.</p>
<div class="section">
<h3><a name="Testing_against_different_regions"></a>Testing against different regions</h3>
<p>S3A can connect to different regions &#x2014;the tests support this. Simply define the target region in <tt>auth-keys.xml</tt>.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.endpoint&lt;/name&gt;
  &lt;value&gt;s3.eu-central-1.amazonaws.com&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>This is used for all tests expect for scale tests using a Public CSV.gz file (see below)</p></div>
<div class="section">
<h3><a name="CSV_Data_source_Tests"></a>CSV Data source Tests</h3>
<p>The <tt>TestS3AInputStreamPerformance</tt> tests require read access to a multi-MB text file. The default file for these tests is one published by amazon, <a class="externalLink" href="http://landsat-pds.s3.amazonaws.com/scene_list.gz">s3a://landsat-pds.s3.amazonaws.com/scene_list.gz</a>. This is a gzipped CSV index of other files which amazon serves for open use.</p>
<p>The path to this object is set in the option <tt>fs.s3a.scale.test.csvfile</tt>,</p>

<div class="source">
<div class="source">
<pre>    &lt;property&gt;
      &lt;name&gt;fs.s3a.scale.test.csvfile&lt;/name&gt;
      &lt;value&gt;s3a://landsat-pds/scene_list.gz&lt;/value&gt;
    &lt;/property&gt;
</pre></div></div>

<ol style="list-style-type: decimal">
  
<li>If the option is not overridden, the default value is used. This is hosted in Amazon&#x2019;s US-east datacenter.</li>
  
<li>If <tt>fs.s3a.scale.test.csvfile</tt> is empty, tests which require it will be skipped.</li>
  
<li>If the data cannot be read for any reason then the test will fail.</li>
  
<li>If the property is set to a different path, then that data must be readable and &#x201c;sufficiently&#x201d; large.</li>
</ol>
<p>(the reason the space or newline is needed is to add &#x201c;an empty entry&#x201d;; an empty <tt>&lt;value/&gt;</tt> would be considered undefined and pick up the default)</p>
<p>Of using a test file in an S3 region requiring a different endpoint value set in <tt>fs.s3a.endpoint</tt>, a bucket-specific endpoint must be defined. For the default test dataset, hosted in the <tt>landsat-pds</tt> bucket, this is:</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.bucket.landsat-pds.endpoint&lt;/name&gt;
  &lt;value&gt;s3.amazonaws.com&lt;/value&gt;
  &lt;description&gt;The endpoint for s3a://landsat-pds URLs&lt;/description&gt;
&lt;/property&gt;
</pre></div></div></div>
<div class="section">
<h3><a name="Viewing_Integration_Test_Reports"></a>Viewing Integration Test Reports</h3>
<p>Integration test results and logs are stored in <tt>target/failsafe-reports/</tt>. An HTML report can be generated during site generation, or with the <tt>surefire-report</tt> plugin:</p>

<div class="source">
<div class="source">
<pre>mvn surefire-report:failsafe-report-only
</pre></div></div></div>
<div class="section">
<h3><a name="Scale_Tests"></a>Scale Tests</h3>
<p>There are a set of tests designed to measure the scalability and performance at scale of the S3A tests, <i>Scale Tests</i>. Tests include: creating and traversing directory trees, uploading large files, renaming them, deleting them, seeking through the files, performing random IO, and others. This makes them a foundational part of the benchmarking.</p>
<p>By their very nature they are slow. And, as their execution time is often limited by bandwidth between the computer running the tests and the S3 endpoint, parallel execution does not speed these tests up.</p>
<div class="section">
<h4><a name="Enabling_the_Scale_Tests"></a>Enabling the Scale Tests</h4>
<p>The tests are enabled if the <tt>scale</tt> property is set in the maven build this can be done regardless of whether or not the parallel test profile is used</p>

<div class="source">
<div class="source">
<pre>mvn verify -Dscale

mvn verify -Dparallel-tests -Dscale -DtestsThreadCount=8
</pre></div></div>
<p>The most bandwidth intensive tests (those which upload data) always run sequentially; those which are slow due to HTTPS setup costs or server-side actionsare included in the set of parallelized tests.</p></div>
<div class="section">
<h4><a name="Maven_build_tuning_options"></a>Maven build tuning options</h4>
<p>Some of the tests can be tuned from the maven build or from the configuration file used to run the tests.</p>

<div class="source">
<div class="source">
<pre>mvn verify -Dparallel-tests -Dscale -DtestsThreadCount=8 -Dfs.s3a.scale.test.huge.filesize=128M
</pre></div></div>
<p>The algorithm is</p>

<ol style="list-style-type: decimal">
  
<li>The value is queried from the configuration file, using a default value if it is not set.</li>
  
<li>The value is queried from the JVM System Properties, where it is passed down by maven.</li>
  
<li>If the system property is null, an empty string, or it has the value <tt>unset</tt>, then the configuration value is used. The <tt>unset</tt> option is used to <a class="externalLink" href="http://stackoverflow.com/questions/7773134/null-versus-empty-arguments-in-maven">work round a quirk in maven property propagation</a>.</li>
</ol>
<p>Only a few properties can be set this way; more will be added.</p>

<table border="0" class="bodyTable">
  <thead>
    
<tr class="a">
      
<th>Property </th>
      
<th>Meaninging </th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td><tt>fs.s3a.scale.test.timeout</tt></td>
      
<td>Timeout in seconds for scale tests </td>
    </tr>
    
<tr class="a">
      
<td><tt>fs.s3a.scale.test.huge.filesize</tt></td>
      
<td>Size for huge file uploads </td>
    </tr>
    
<tr class="b">
      
<td><tt>fs.s3a.scale.test.huge.huge.partitionsize</tt></td>
      
<td>Size for partitions in huge file uploads </td>
    </tr>
  </tbody>
</table>
<p>The file and partition sizes are numeric values with a k/m/g/t/p suffix depending on the desired size. For example: 128M, 128m, 2G, 2G, 4T or even 1P.</p></div>
<div class="section">
<h4><a name="Scale_test_configuration_options"></a>Scale test configuration options</h4>
<p>Some scale tests perform multiple operations (such as creating many directories).</p>
<p>The exact number of operations to perform is configurable in the option <tt>scale.test.operation.count</tt></p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;scale.test.operation.count&lt;/name&gt;
  &lt;value&gt;10&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>Larger values generate more load, and are recommended when testing locally, or in batch runs.</p>
<p>Smaller values results in faster test runs, especially when the object store is a long way away.</p>
<p>Operations which work on directories have a separate option: this controls the width and depth of tests creating recursive directories. Larger values create exponentially more directories, with consequent performance impact.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;scale.test.directory.count&lt;/name&gt;
  &lt;value&gt;2&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>DistCp tests targeting S3A support a configurable file size. The default is 10 MB, but the configuration value is expressed in KB so that it can be tuned smaller to achieve faster test runs.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;scale.test.distcp.file.size.kb&lt;/name&gt;
  &lt;value&gt;10240&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>S3A specific scale test properties are</p>
<div class="section">
<h5><a name="fs.s3a.scale.test.huge.filesize:_size_in_MB_for_Huge_file_tests."></a><tt>fs.s3a.scale.test.huge.filesize</tt>: size in MB for &#x201c;Huge file tests&#x201d;.</h5>
<p>The Huge File tests validate S3A&#x2019;s ability to handle large files &#x2014;the property <tt>fs.s3a.scale.test.huge.filesize</tt> declares the file size to use.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.scale.test.huge.filesize&lt;/name&gt;
  &lt;value&gt;200M&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>Amazon S3 handles files larger than 5GB differently than smaller ones. Setting the huge filesize to a number greater than that) validates support for huge files.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.scale.test.huge.filesize&lt;/name&gt;
  &lt;value&gt;6G&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>Tests at this scale are slow: they are best executed from hosts running in the cloud infrastructure where the S3 endpoint is based. Otherwise, set a large timeout in <tt>fs.s3a.scale.test.timeout</tt></p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.scale.test.timeout&lt;/name&gt;
  &lt;value&gt;432000&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>The tests are executed in an order to only clean up created files after the end of all the tests. If the tests are interrupted, the test data will remain.</p></div></div></div></div>
<div class="section">
<h2><a name="Testing_against_non_AWS_S3_endpoints."></a>Testing against non AWS S3 endpoints.</h2>
<p>The S3A filesystem is designed to work with storage endpoints which implement the S3 protocols to the extent that the amazon S3 SDK is capable of talking to it. We encourage testing against other filesystems and submissions of patches which address issues. In particular, we encourage testing of Hadoop release candidates, as these third-party endpoints get even less testing than the S3 endpoint itself.</p>
<div class="section">
<h3><a name="Disabling_the_encryption_tests"></a>Disabling the encryption tests</h3>
<p>If the endpoint doesn&#x2019;t support server-side-encryption, these will fail. They can be turned off.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;test.fs.s3a.encryption.enabled&lt;/name&gt;
  &lt;value&gt;false&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>Encryption is only used for those specific test suites with <tt>Encryption</tt> in their classname.</p></div>
<div class="section">
<h3><a name="Configuring_the_CSV_file_read_tests"></a>Configuring the CSV file read tests**</h3>
<p>To test on alternate infrastructures supporting the same APIs, the option <tt>fs.s3a.scale.test.csvfile</tt> must either be set to &#x201c; &#x201d;, or an object of at least 10MB is uploaded to the object store, and the <tt>fs.s3a.scale.test.csvfile</tt> option set to its path.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.scale.test.csvfile&lt;/name&gt;
  &lt;value&gt; &lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>(yes, the space is necessary. The Hadoop <tt>Configuration</tt> class treats an empty value as &#x201c;do not override the default&#x201d;).</p></div>
<div class="section">
<h3><a name="Testing_Session_Credentials"></a>Testing Session Credentials</h3>
<p>The test <tt>TestS3ATemporaryCredentials</tt> requests a set of temporary credentials from the STS service, then uses them to authenticate with S3.</p>
<p>If an S3 implementation does not support STS, then the functional test cases must be disabled:</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;test.fs.s3a.sts.enabled&lt;/name&gt;
  &lt;value&gt;false&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>These tests reqest a temporary set of credentials from the STS service endpoint. An alternate endpoint may be defined in <tt>test.fs.s3a.sts.endpoint</tt>.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;test.fs.s3a.sts.endpoint&lt;/name&gt;
  &lt;value&gt;https://sts.example.org/&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>The default is &quot;&#x201c;; meaning &#x201d;use the amazon default value&quot;.</p></div></div>
<div class="section">
<h2><a name="Debugging_Test_failures"></a>Debugging Test failures</h2>
<p>Logging at debug level is the standard way to provide more diagnostics output; after setting this rerun the tests</p>

<div class="source">
<div class="source">
<pre>log4j.logger.org.apache.hadoop.fs.s3a=DEBUG
</pre></div></div>
<p>There are also some logging options for debug logging of the AWS client <tt>properties
log4j.logger.com.amazonaws=DEBUG
log4j.logger.com.amazonaws.http.conn.ssl=INFO
log4j.logger.com.amazonaws.internal=INFO
</tt></p>
<p>There is also the option of enabling logging on a bucket; this could perhaps be used to diagnose problems from that end. This isn&#x2019;t something actively used, but remains an option. If you are forced to debug this way, consider setting the <tt>fs.s3a.user.agent.prefix</tt> to a unique prefix for a specific test run, which will enable the specific log entries to be more easily located.</p></div>
<div class="section">
<h2><a name="Adding_new_tests"></a>Adding new tests</h2>
<p>New tests are always welcome. Bear in mind that we need to keep costs and test time down, which is done by</p>

<ul>
  
<li>Not duplicating tests.</li>
  
<li>Being efficient in your use of Hadoop API calls.</li>
  
<li>Isolating large/slow tests into the &#x201c;scale&#x201d; test group.</li>
  
<li>Designing all tests to execute in parallel (where possible).</li>
  
<li>Adding new probes and predicates into existing tests, albeit carefully.</li>
</ul>
<p><i>No duplication</i>: if an operation is tested elsewhere, don&#x2019;t repeat it. This applies as much for metadata operations as it does for bulk IO. If a new test case is added which completely obsoletes an existing test, it is OK to cut the previous one &#x2014;after showing that coverage is not worsened.</p>
<p><i>Efficient</i>: prefer the <tt>getFileStatus()</tt> and examining the results, rather than call to <tt>exists()</tt>, <tt>isFile()</tt>, etc.</p>
<p><i>Isolating Scale tests</i>. Any S3A test doing large amounts of IO MUST extend the class <tt>S3AScaleTestBase</tt>, so only running if <tt>scale</tt> is defined on a build, supporting test timeouts configurable by the user. Scale tests should also support configurability as to the actual size of objects/number of operations, so that behavior at different scale can be verified.</p>
<p><i>Designed for parallel execution</i>. A key need here is for each test suite to work on isolated parts of the filesystem. Subclasses of <tt>AbstractS3ATestBase</tt> SHOULD use the <tt>path()</tt> method, with a base path of the test suite name, to build isolated paths. Tests MUST NOT assume that they have exclusive access to a bucket.</p>
<p><i>Extending existing tests where appropriate</i>. This recommendation goes against normal testing best practise of &#x201c;test one thing per method&#x201d;. Because it is so slow to create directory trees or upload large files, we do not have that luxury. All the tests against real S3 endpoints are integration tests where sharing test setup and teardown saves time and money.</p>
<p>A standard way to do this is to extend existing tests with some extra predicates, rather than write new tests. When doing this, make sure that the new predicates fail with meaningful diagnostics, so any new problems can be easily debugged from test logs.</p>
<div class="section">
<h3><a name="Requirements_of_new_Tests"></a>Requirements of new Tests</h3>
<p>This is what we expect from new tests; they&#x2019;re an extension of the normal Hadoop requirements, based on the need to work with remote servers whose use requires the presence of secret credentials, where tests may be slow, and where finding out why something failed from nothing but the test output is critical.</p>
<div class="section">
<h4><a name="Subclasses_Existing_Shared_Base_Classes"></a>Subclasses Existing Shared Base Classes</h4>
<p>Extend <tt>AbstractS3ATestBase</tt> or <tt>AbstractSTestS3AHugeFiles</tt> unless justifiable. These set things up for testing against the object stores, provide good threadnames, help generate isolated paths, and for <tt>AbstractSTestS3AHugeFiles</tt> subclasses, only run if <tt>-Dscale</tt> is set.</p>
<p>Key features of <tt>AbstractS3ATestBase</tt></p>

<ul>
  
<li><tt>getFileSystem()</tt> returns the S3A Filesystem bonded to the contract test Filesystem defined in <tt>fs.s3a.contract.test</tt></li>
  
<li>will automatically skip all tests if that URL is unset.</li>
  
<li>Extends <tt>AbstractFSContractTestBase</tt> and <tt>Assert</tt> for all their methods.</li>
</ul>
<p>Having shared base classes may help reduce future maintenance too. Please use them/</p></div>
<div class="section">
<h4><a name="Secure"></a>Secure</h4>
<p>Don&#x2019;t ever log credentials. The credential tests go out of their way to not provide meaningful logs or assertion messages precisely to avoid this.</p></div>
<div class="section">
<h4><a name="Efficient_of_Time_and_Money"></a>Efficient of Time and Money</h4>
<p>This means efficient in test setup/teardown, and, ideally, making use of existing public datasets to save setup time and tester cost.</p>
<p>Strategies of particular note are:</p>

<ol style="list-style-type: decimal">
  
<li><tt>ITestS3ADirectoryPerformance</tt>: a single test case sets up the directory tree then performs different list operations, measuring the time taken.</li>
  
<li><tt>AbstractSTestS3AHugeFiles</tt>: marks the test suite as <tt>@FixMethodOrder(MethodSorters.NAME_ASCENDING)</tt> then orders the test cases such that each test case expects the previous test to have completed (here: uploaded a file, renamed a file, &#x2026;). This provides for independent tests in the reports, yet still permits an ordered sequence of operations. Do note the use of <tt>Assume.assume()</tt> to detect when the preconditions for a single test case are not met, hence, the tests become skipped, rather than fail with a trace which is really a false alarm.</li>
</ol>
<p>The ordered test case mechanism of <tt>AbstractSTestS3AHugeFiles</tt> is probably the most elegant way of chaining test setup/teardown.</p>
<p>Regarding reusing existing data, we tend to use the landsat archive of AWS US-East for our testing of input stream operations. This doesn&#x2019;t work against other regions, or with third party S3 implementations. Thus the URL can be overridden for testing elsewhere.</p></div>
<div class="section">
<h4><a name="Works_With_Other_S3_Endpoints"></a>Works With Other S3 Endpoints</h4>
<p>Don&#x2019;t assume AWS S3 US-East only, do allow for working with external S3 implementations. Those may be behind the latest S3 API features, not support encryption, session APIs, etc.</p></div></div>
<div class="section">
<h3><a name="Works_Over_Long-haul_Links"></a>Works Over Long-haul Links</h3>
<p>As well as making file size and operation counts scaleable, this includes making test timeouts adequate. The Scale tests make this configurable; it&#x2019;s hard coded to ten minutes in <tt>AbstractS3ATestBase()</tt>; subclasses can change this by overriding <tt>getTestTimeoutMillis()</tt>.</p>
<p>Equally importantly: support proxies, as some testers need them.</p></div>
<div class="section">
<h3><a name="Provides_Diagnostics_and_timing_information"></a>Provides Diagnostics and timing information</h3>

<ol style="list-style-type: decimal">
  
<li>Give threads useful names.</li>
  
<li>Create logs, log things. Know that the <tt>S3AFileSystem</tt> and its input and output streams <i>all</i> provide useful statistics in their {{toString()}} calls; logging them is useful on its own.</li>
  
<li>you can use <tt>AbstractS3ATestBase.describe(format-stringm, args)</tt> here.; it adds some newlines so as to be easier to spot.</li>
  
<li>Use <tt>ContractTestUtils.NanoTimer</tt> to measure the duration of operations, and log the output.</li>
</ol>
<div class="section">
<h4><a name="Fails_Meaningfully"></a>Fails Meaningfully</h4>
<p>The <tt>ContractTestUtils</tt> class contains a whole set of assertions for making statements about the expected state of a filesystem, e.g. <tt>assertPathExists(FS, path)</tt>, <tt>assertPathDoesNotExists(FS, path)</tt>, and others. These do their best to provide meaningful diagnostics on failures (e.g. directory listings, file status, &#x2026;), so help make failures easier to understand.</p>
<p>At the very least, do not use <tt>assertTrue()</tt> or <tt>assertFalse()</tt> without including error messages.</p></div></div>
<div class="section">
<h3><a name="Cleans_Up_Afterwards"></a>Cleans Up Afterwards</h3>
<p>Keeps costs down.</p>

<ol style="list-style-type: decimal">
  
<li>Do not only cleanup if a test case completes successfully; test suite teardown must do it.</li>
  
<li>That teardown code must check for the filesystem and other fields being null before the cleanup. Why? If test setup fails, the teardown methods still get called.</li>
</ol></div>
<div class="section">
<h3><a name="Works_Reliably"></a>Works Reliably</h3>
<p>We really appreciate this &#x2014; you will too.</p></div></div>
<div class="section">
<h2><a name="Testing_s3:"></a>Testing s3://</h2>
<p>The configuration tests must declare the test bucket <tt>test.fs.s3.name</tt> and the credentials for the s3:// filesystem, and the contract test bucket <tt>fs.contract.test.fs.s3</tt></p>
<div class="section">
<h3><a name="s3:"></a>s3://</h3>
<p>The filesystem name must be defined in the property <tt>fs.contract.test.fs.s3</tt>. The same bucket name can be used for all tests</p>
<p>Example:</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;test.fs.s3.name&lt;/name&gt;
  &lt;value&gt;s3://test-aws-s3/&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;fs.contract.test.fs.s3&lt;/name&gt;
  &lt;value&gt;${test.fs.s3.name}&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;fs.s3.awsAccessKeyId&lt;/name&gt;
  &lt;value&gt;DONOTPCOMMITTHISKEYTOSCM&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;fs.s3.awsSecretAccessKey&lt;/name&gt;
  &lt;value&gt;DONOTEVERSHARETHISSECRETKEY!&lt;/value&gt;
&lt;/property&gt;
</pre></div></div></div></div>
<div class="section">
<h2><a name="Tips"></a>Tips</h2>
<div class="section">
<h3><a name="How_to_keep_your_credentials_really_safe"></a>How to keep your credentials really safe</h3>
<p>Although the <tt>auth-keys.xml</tt> file is marked as ignored in git and subversion, it is still in your source tree, and there&#x2019;s always that risk that it may creep out.</p>
<p>You can avoid this by keeping your keys outside the source tree and using an absolute XInclude reference to it.</p>

<div class="source">
<div class="source">
<pre>&lt;configuration&gt;

  &lt;include xmlns=&quot;http://www.w3.org/2001/XInclude&quot;
    href=&quot;file:///users/ubuntu/.auth-keys.xml&quot; /&gt;

&lt;/configuration&gt;
</pre></div></div>
<h1>Failure Injection</h1>
<p><b>Warning do not enable any type of failure injection in production. The following settings are for testing only.</b></p>
<p>One of the challenges with S3A integration tests is the fact that S3 is an eventually-consistent storage system. In practice, we rarely see delays in visibility of recently created objects both in listings (<tt>listStatus()</tt>) and when getting a single file&#x2019;s metadata (<tt>getFileStatus()</tt>). Since this behavior is rare and non-deterministic, thorough integration testing is challenging.</p>
<p>To address this, S3A supports a shim layer on top of the <tt>AmazonS3Client</tt> class which artificially delays certain paths from appearing in listings. This is implemented in the class <tt>InconsistentAmazonS3Client</tt>.</p></div></div>
<div class="section">
<h2><a name="Simulating_List_Inconsistencies"></a>Simulating List Inconsistencies</h2>
<div class="section">
<h3><a name="Enabling_the_InconsistentAmazonS3CClient"></a>Enabling the InconsistentAmazonS3CClient</h3>
<p>There are two ways of enabling the <tt>InconsistentAmazonS3Client</tt>: at config-time, or programmatically. For an example of programmatic test usage, see <tt>ITestS3GuardListConsistency</tt>.</p>
<p>To enable the fault-injecting client via configuration, switch the S3A client to use the &#x201c;Inconsistent S3 Client Factory&#x201d; when connecting to S3:</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.s3.client.factory.impl&lt;/name&gt;
  &lt;value&gt;org.apache.hadoop.fs.s3a.InconsistentS3ClientFactory&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>The inconsistent client works by:</p>

<ol style="list-style-type: decimal">
  
<li>Choosing which objects will be &#x201c;inconsistent&#x201d; at the time the object is created or deleted.</li>
  
<li>When <tt>listObjects()</tt> is called, any keys that we have marked as inconsistent above will not be returned in the results (until the configured delay has elapsed). Similarly, deleted items may be <i>added</i> to missing results to delay the visibility of the delete.</li>
</ol>
<p>There are two ways of choosing which keys (filenames) will be affected: By substring, and by random probability.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.failinject.inconsistency.key.substring&lt;/name&gt;
  &lt;value&gt;DELAY_LISTING_ME&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;fs.s3a.failinject.inconsistency.probability&lt;/name&gt;
  &lt;value&gt;1.0&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>By default, any object which has the substring &#x201c;DELAY_LISTING_ME&#x201d; in its key will subject to delayed visibility. For example, the path <tt>s3a://my-bucket/test/DELAY_LISTING_ME/file.txt</tt> would match this condition. To match all keys use the value &#x201c;*&#x201d; (a single asterisk). This is a special value: <i>We don&#x2019;t support arbitrary wildcards.</i></p>
<p>The default probability of delaying an object is 1.0. This means that <i>all</i> keys that match the substring will get delayed visibility. Note that we take the logical <i>and</i> of the two conditions (substring matches <i>and</i> probability random chance occurs). Here are some example configurations:</p>

<div class="source">
<div class="source">
<pre>| substring | probability |  behavior                                  |
|-----------|-------------|--------------------------------------------|
|           | 0.001       | An empty &lt;value&gt; tag in .xml config will   |
|           |             | be interpreted as unset and revert to the  |
|           |             | default value, &quot;DELAY_LISTING_ME&quot;          |
|           |             |                                            |
| *         | 0.001       | 1/1000 chance of *any* key being delayed.  |
|           |             |                                            |
| delay     | 0.01        | 1/100 chance of any key containing &quot;delay&quot; |
|           |             |                                            |
| delay     | 1.0         | All keys containing substring &quot;delay&quot; ..   |
</pre></div></div>
<p>You can also configure how long you want the delay in visibility to last. The default is 5000 milliseconds (five seconds).</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.failinject.inconsistency.msec&lt;/name&gt;
  &lt;value&gt;5000&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>Future versions of this client will introduce new failure modes, with simulation of S3 throttling exceptions the next feature under development.</p></div>
<div class="section">
<h3><a name="Limitations_of_Inconsistency_Injection"></a>Limitations of Inconsistency Injection</h3>
<p>Although <tt>InconsistentAmazonS3Client</tt> can delay the visibility of an object or parent directory, it does not prevent the key of that object from appearing in all prefix searches. For example, if we create the following object with the default configuration above, in an otherwise empty bucket:</p>

<div class="source">
<div class="source">
<pre>s3a://bucket/a/b/c/DELAY_LISTING_ME
</pre></div></div>
<p>Then the following paths will still be visible as directories (ignoring possible real-world inconsistencies):</p>

<div class="source">
<div class="source">
<pre>s3a://bucket/a
s3a://bucket/a/b
</pre></div></div>
<p>Whereas <tt>getFileStatus()</tt> on the following <i>will</i> be subject to delayed visibility (<tt>FileNotFoundException</tt> until delay has elapsed):</p>

<div class="source">
<div class="source">
<pre>s3a://bucket/a/b/c
s3a://bucket/a/b/c/DELAY_LISTING_ME
</pre></div></div>
<p>In real-life S3 inconsistency, however, we expect that all the above paths (including <tt>a</tt> and <tt>b</tt>) will be subject to delayed visiblity.</p></div>
<div class="section">
<h3><a name="Using_the_InconsistentAmazonS3CClient_in_downstream_integration_tests"></a>Using the <tt>InconsistentAmazonS3CClient</tt> in downstream integration tests</h3>
<p>The inconsistent client is shipped in the <tt>hadoop-aws</tt> JAR, so it can be used in applications which work with S3 to see how they handle inconsistent directory listings.</p></div></div>
<div class="section">
<h2><a name="Testing_S3Guard"></a>Testing S3Guard</h2>
<p>The basic strategy for testing S3Guard correctness consists of:</p>

<ol style="list-style-type: decimal">
  
<li>
<p>MetadataStore Contract tests.</p>
<p>The MetadataStore contract tests are inspired by the Hadoop FileSystem and <tt>FileContext</tt> contract tests. Each implementation of the <tt>MetadataStore</tt> interface subclasses the <tt>MetadataStoreTestBase</tt> class and customizes it to initialize their MetadataStore. This test ensures that the different implementations all satisfy the semantics of the MetadataStore API.</p></li>
  
<li>
<p>Running existing S3A unit and integration tests with S3Guard enabled.</p>
<p>You can run the S3A integration tests on top of S3Guard by configuring your <tt>MetadataStore</tt> in your <tt>hadoop-tools/hadoop-aws/src/test/resources/core-site.xml</tt> or <tt>hadoop-tools/hadoop-aws/src/test/resources/auth-keys.xml</tt> files. Next run the S3A integration tests as outlined in the <i>Running the Tests</i> section of the <a href="./index.html">S3A documentation</a></p></li>
  
<li>
<p>Running fault-injection tests that test S3Guard&#x2019;s consistency features.</p>
<p>The <tt>ITestS3GuardListConsistency</tt> uses failure injection to ensure that list consistency logic is correct even when the underlying storage is eventually consistent.</p>
<p>The integration test adds a shim above the Amazon S3 Client layer that injects delays in object visibility.</p>
<p>All of these tests will be run if you follow the steps listed in step 2 above.</p>
<p>No charges are incurred for using this store, and its consistency guarantees are that of the underlying object store instance. <!-- :) --></p></li>
</ol></div>
<div class="section">
<h2><a name="Testing_S3A_with_S3Guard_Enabled"></a>Testing S3A with S3Guard Enabled</h2>
<p>All the S3A tests which work with a private repository can be configured to run with S3Guard by using the <tt>s3guard</tt> profile. When set, this will run all the tests with local memory for the metadata set to &#x201c;non-authoritative&#x201d; mode.</p>

<div class="source">
<div class="source">
<pre>mvn -T 1C verify -Dparallel-tests -DtestsThreadCount=6 -Ds3guard
</pre></div></div>
<p>When the <tt>s3guard</tt> profile is enabled, following profiles can be specified:</p>

<ul>
  
<li><tt>dynamo</tt>: use an AWS-hosted DynamoDB table; creating the table if it does  not exist. You will have to pay the bills for DynamoDB web service.</li>
  
<li><tt>dynamodblocal</tt>: use an in-memory DynamoDBLocal server instead of real AWS  DynamoDB web service; launch the server and creating the table.  You won&#x2019;t be charged bills for using DynamoDB in test. As it runs in-JVM,  the table isn&#x2019;t shared across other tests running in parallel.</li>
  
<li><tt>non-auth</tt>: treat the S3Guard metadata as authorative.</li>
</ul>

<div class="source">
<div class="source">
<pre>mvn -T 1C verify -Dparallel-tests -DtestsThreadCount=6 -Ds3guard -Ddynamo -Dauth
</pre></div></div>
<p>When experimenting with options, it is usually best to run a single test suite at a time until the operations appear to be working.</p>

<div class="source">
<div class="source">
<pre>mvn -T 1C verify -Dtest=skip -Dit.test=ITestS3AMiscOperations -Ds3guard -Ddynamo
</pre></div></div>
<div class="section">
<h3><a name="Notes"></a>Notes</h3>

<ol style="list-style-type: decimal">
  
<li>If the <tt>s3guard</tt> profile is not set, then the S3Guard properties are those of the test configuration set in <tt>contract-test-options.xml</tt> or <tt>auth-keys.xml</tt></li>
</ol>
<p>If the <tt>s3guard</tt> profile <i>is</i> set, 1. The S3Guard options from maven (the dynamo and authoritative flags)  overwrite any previously set in the configuration files. 1. DynamoDB will be configured to create any missing tables.</p></div>
<div class="section">
<h3><a name="Warning_About_Concurrent_Tests"></a>Warning About Concurrent Tests</h3>
<p>You must not run S3A and S3N tests in parallel on the same bucket. This is especially true when S3Guard is enabled. S3Guard requires that all clients that are modifying the bucket have S3Guard enabled, so having S3N integration tests running in parallel with S3A tests will cause strange failures.</p></div>
<div class="section">
<h3><a name="Scale_Testing_MetadataStore_Directly"></a>Scale Testing MetadataStore Directly</h3>
<p>There are some scale tests that exercise Metadata Store implementations directly. These ensure that S3Guard is are robust to things like DynamoDB throttling, and compare performance for different implementations. These are included in the scale tests executed when <tt>-Dscale</tt> is passed to the maven command line.</p>
<p>The two S3Guard scale testse are <tt>ITestDynamoDBMetadataStoreScale</tt> and <tt>ITestLocalMetadataStoreScale</tt>. To run the DynamoDB test, you will need to define your table name and region in your test configuration. For example, the following settings allow us to run <tt>ITestDynamoDBMetadataStoreScale</tt> with artificially low read and write capacity provisioned, so we can judge the effects of being throttled by the DynamoDB service:</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;scale.test.operation.count&lt;/name&gt;
  &lt;value&gt;10&lt;/value&gt;
&lt;/property&gt;
&lt;property&gt;
  &lt;name&gt;scale.test.directory.count&lt;/name&gt;
  &lt;value&gt;3&lt;/value&gt;
&lt;/property&gt;
&lt;property&gt;
  &lt;name&gt;fs.s3a.scale.test.enabled&lt;/name&gt;
  &lt;value&gt;true&lt;/value&gt;
&lt;/property&gt;
&lt;property&gt;
  &lt;name&gt;fs.s3a.s3guard.ddb.table&lt;/name&gt;
  &lt;value&gt;my-scale-test&lt;/value&gt;
&lt;/property&gt;
&lt;property&gt;
  &lt;name&gt;fs.s3a.s3guard.ddb.region&lt;/name&gt;
  &lt;value&gt;us-west-2&lt;/value&gt;
&lt;/property&gt;
&lt;property&gt;
  &lt;name&gt;fs.s3a.s3guard.ddb.table.create&lt;/name&gt;
  &lt;value&gt;true&lt;/value&gt;
&lt;/property&gt;
&lt;property&gt;
  &lt;name&gt;fs.s3a.s3guard.ddb.table.capacity.read&lt;/name&gt;
  &lt;value&gt;10&lt;/value&gt;
&lt;/property&gt;
&lt;property&gt;
  &lt;name&gt;fs.s3a.s3guard.ddb.table.capacity.write&lt;/name&gt;
  &lt;value&gt;10&lt;/value&gt;
&lt;/property&gt;
</pre></div></div></div>
<div class="section">
<h3><a name="Testing_only:_Local_Metadata_Store"></a>Testing only: Local Metadata Store</h3>
<p>There is an in-memory Metadata Store for testing.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.metadatastore.impl&lt;/name&gt;
  &lt;value&gt;org.apache.hadoop.fs.s3a.s3guard.LocalMetadataStore&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>This is not for use in production.</p></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        &#169;            2018
              Apache Software Foundation
            
                          - <a href="http://maven.apache.org/privacy-policy.html">Privacy Policy</a>.
        Apache Maven, Maven, Apache, the Apache feather logo, and the Apache Maven project logos are trademarks of The Apache Software Foundation.
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
