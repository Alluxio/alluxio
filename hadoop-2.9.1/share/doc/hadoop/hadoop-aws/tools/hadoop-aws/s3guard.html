<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
 | Generated by Apache Maven Doxia at 2018-04-16
 | Rendered using Apache Maven Stylus Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Apache Hadoop Amazon Web Services support &#x2013; S3Guard: Consistency and Metadata Caching for S3A</title>
    <style type="text/css" media="all">
      @import url("../../css/maven-base.css");
      @import url("../../css/maven-theme.css");
      @import url("../../css/site.css");
    </style>
    <link rel="stylesheet" href="../../css/print.css" type="text/css" media="print" />
        <meta name="Date-Revision-yyyymmdd" content="20180416" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
                </head>
  <body class="composite">
    <div id="banner">
                        <a href="http://hadoop.apache.org/" id="bannerLeft">
                                        <img src="http://hadoop.apache.org/images/hadoop-logo.jpg" alt="" />
                </a>
                              <a href="http://www.apache.org/" id="bannerRight">
                                        <img src="http://www.apache.org/images/asf_logo_wide.png" alt="" />
                </a>
            <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                                   <div class="xleft">
                          <a href="http://www.apache.org/" class="externalLink">Apache</a>
        &gt;
                  <a href="http://hadoop.apache.org/" class="externalLink">Hadoop</a>
        &gt;
                  <a href="../../index.html">Apache Hadoop Amazon Web Services support</a>
        &gt;
        S3Guard: Consistency and Metadata Caching for S3A
        </div>
            <div class="xright">            <a href="http://wiki.apache.org/hadoop" class="externalLink">Wiki</a>
            |
                <a href="https://git-wip-us.apache.org/repos/asf/hadoop.git" class="externalLink">git</a>
              
                                   &nbsp;| Last Published: 2018-04-16
              &nbsp;| Version: 2.9.1
            </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                                                   <h5>General</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../index.html">Overview</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/SingleCluster.html">Single Node Setup</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/ClusterSetup.html">Cluster Setup</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/CommandsManual.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/FileSystemShell.html">FileSystem Shell</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Compatibility.html">Hadoop Compatibility</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/InterfaceClassification.html">Interface Classification</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/filesystem/index.html">FileSystem Specification</a>
            </li>
          </ul>
                       <h5>Common</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/CLIMiniCluster.html">CLI Mini Cluster</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/NativeLibraries.html">Native Libraries</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Superusers.html">Proxy User</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/RackAwareness.html">Rack Awareness</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/SecureMode.html">Secure Mode</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/ServiceLevelAuth.html">Service Level Authorization</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/HttpAuthentication.html">HTTP Authentication</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/CredentialProviderAPI.html">Credential Provider API</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-kms/index.html">Hadoop KMS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Tracing.html">Tracing</a>
            </li>
          </ul>
                       <h5>HDFS</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsDesign.html">Architecture</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsUserGuide.html">User Guide</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSCommands.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSHighAvailabilityWithQJM.html">NameNode HA With QJM</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSHighAvailabilityWithNFS.html">NameNode HA With NFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/Federation.html">Federation</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ViewFs.html">ViewFs</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsSnapshots.html">Snapshots</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsEditsViewer.html">Edits Viewer</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsImageViewer.html">Image Viewer</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html">Permissions and HDFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsQuotaAdminGuide.html">Quotas and HDFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/Hftp.html">HFTP</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/LibHdfs.html">libhdfs (C API)</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/WebHDFS.html">WebHDFS (REST API)</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-hdfs-httpfs/index.html">HttpFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ShortCircuitLocalReads.html">Short Circuit Local Reads</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/CentralizedCacheManagement.html">Centralized Cache Management</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsNfsGateway.html">NFS Gateway</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsRollingUpgrade.html">Rolling Upgrade</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ExtendedAttributes.html">Extended Attributes</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/TransparentEncryption.html">Transparent Encryption</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsMultihoming.html">Multihoming</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ArchivalStorage.html">Storage Policies</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/MemoryStorage.html">Memory Storage Support</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsUpgradeDomain.html">Upgrade Domain</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsDataNodeAdminGuide.html">DataNode Admin</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs-rbf/HDFSRouterFederation.html">Router Federation</a>
            </li>
          </ul>
                       <h5>MapReduce</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduceTutorial.html">Tutorial</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapredCommands.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduce_Compatibility_Hadoop1_Hadoop2.html">Compatibility with 1.x</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/EncryptedShuffle.html">Encrypted Shuffle</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/PluggableShuffleAndPluggableSort.html">Pluggable Shuffle/Sort</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/DistributedCacheDeploy.html">Distributed Cache Deploy</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/SharedCacheSupport.html">Support for YARN Shared Cache</a>
            </li>
          </ul>
                       <h5>MapReduce REST APIs</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapredAppMasterRest.html">MR Application Master</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-hs/HistoryServerRest.html">MR History Server</a>
            </li>
          </ul>
                       <h5>YARN</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/YARN.html">Architecture</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/YarnCommands.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/CapacityScheduler.html">Capacity Scheduler</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/FairScheduler.html">Fair Scheduler</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ResourceManagerRestart.html">ResourceManager Restart</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ResourceManagerHA.html">ResourceManager HA</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeLabel.html">Node Labels</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/WebApplicationProxy.html">Web Application Proxy</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServer.html">Timeline Server</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServiceV2.html">Timeline Service V.2</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/WritingYarnApplications.html">Writing YARN Applications</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/YarnApplicationSecurity.html">YARN Application Security</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeManager.html">NodeManager</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/DockerContainerExecutor.html">DockerContainerExecutor</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/DockerContainers.html">Running Applications in Docker Containers</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeManagerCgroups.html">Using CGroups</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/SecureContainer.html">Secure Containers</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/registry/index.html">Registry</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ReservationSystem.html">Reservation System</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/GracefulDecommission.html">Graceful Decommission</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/OpportunisticContainers.html">Opportunistic Containers</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/Federation.html">YARN Federation</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/SharedCache.html">Shared Cache</a>
            </li>
          </ul>
                       <h5>YARN REST APIs</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/WebServicesIntro.html">Introduction</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ResourceManagerRest.html">Resource Manager</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeManagerRest.html">Node Manager</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServer.html#Timeline_Server_REST_API_v1">Timeline Server</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServiceV2.html#Timeline_Service_v.2_REST_API">Timeline Service V.2</a>
            </li>
          </ul>
                       <h5>Hadoop Compatible File Systems</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-aws/tools/hadoop-aws/index.html">Amazon S3</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-azure/index.html">Azure Blob Storage</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-openstack/index.html">OpenStack Swift</a>
            </li>
          </ul>
                       <h5>Auth</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-auth/index.html">Overview</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-auth/Examples.html">Examples</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-auth/Configuration.html">Configuration</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-auth/BuildingIt.html">Building</a>
            </li>
          </ul>
                       <h5>Tools</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-streaming/HadoopStreaming.html">Hadoop Streaming</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-archives/HadoopArchives.html">Hadoop Archives</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-archive-logs/HadoopArchiveLogs.html">Hadoop Archive Logs</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-distcp/DistCp.html">DistCp</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-gridmix/GridMix.html">GridMix</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-rumen/Rumen.html">Rumen</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-resourceestimator/ResourceEstimator.html">Resource Estimator Service</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-sls/SchedulerLoadSimulator.html">Scheduler Load Simulator</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Benchmarking.html">Hadoop Benchmarking</a>
            </li>
          </ul>
                       <h5>Reference</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/release/index.html">Changelog and Release Notes</a>
            </li>
                  <li class="none">
                  <a href="../../../api/index.html">API docs</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Metrics.html">Metrics</a>
            </li>
          </ul>
                       <h5>Configuration</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/core-default.xml">core-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/hdfs-default.xml">hdfs-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/mapred-default.xml">mapred-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-common/yarn-default.xml">yarn-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/DeprecatedProperties.html">Deprecated Properties</a>
            </li>
          </ul>
                                 <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
          <img alt="Built by Maven" src="../../images/logos/maven-feather.png"/>
        </a>
                       
                               </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <!---
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. See accompanying LICENSE file.
--><h1>S3Guard: Consistency and Metadata Caching for S3A</h1>
<p><b>Experimental Feature</b></p>

<ul>
<li><a href="#Overview">Overview</a></li>
<li><a href="#Setting_up_S3Guard">Setting up S3Guard</a>
<ul>
<li><a href="#a1._Choose_the_Database">1. Choose the Database</a></li>
<li><a href="#a2._Configure_S3Guard_Settings">2. Configure S3Guard Settings</a></li>
<li><a href="#a3._Configure_the_Metadata_Store.">3. Configure the Metadata Store.</a></li>
<li><a href="#a4._Name_Your_Table">4. Name Your Table</a></li>
<li><a href="#a5._Locate_your_Table">5. Locate your Table</a></li>
<li><a href="#a6._Optional:_Create_your_Table">6. Optional: Create your Table</a></li>
<li><a href="#a7._If_creating_a_table:_Set_your_DynamoDB_IO_Capacity">7. If creating a table: Set your DynamoDB IO Capacity</a></li></ul></li>
<li><a href="#Authenticating_with_S3Guard">Authenticating with S3Guard</a></li>
<li><a href="#Per-bucket_S3Guard_configuration">Per-bucket S3Guard configuration</a></li>
<li><a href="#S3Guard_Command_Line_Interface_CLI">S3Guard Command Line Interface (CLI)</a>
<ul>
<li><a href="#Create_a_table:_s3guard_init">Create a table: s3guard init</a></li>
<li><a href="#Import_a_bucket:_s3guard_import">Import a bucket: s3guard import</a></li>
<li><a href="#Audit_a_table:_s3guard_diff">Audit a table: s3guard diff</a></li>
<li><a href="#Display_information_about_a_bucket_s3guard_bucket-info">Display information about a bucket, s3guard bucket-info</a></li>
<li><a href="#Delete_a_table:_s3guard_destroy">Delete a table: s3guard destroy</a></li>
<li><a href="#Clean_up_a_table_s3guard_prune">Clean up a table, s3guard prune</a></li>
<li><a href="#Tune_the_IO_capacity_of_the_DynamoDB_Table_s3guard_set-capacity">Tune the IO capacity of the DynamoDB Table, s3guard set-capacity</a></li></ul></li>
<li><a href="#Debugging_and_Error_Handling">Debugging and Error Handling</a>
<ul>
<li><a href="#Failure_Semantics">Failure Semantics</a></li>
<li><a href="#Versioning">Versioning</a>
<ul>
<li><a href="#Versioning_policy.">Versioning policy.</a></li></ul></li>
<li><a href="#Security">Security</a></li>
<li><a href="#Troubleshooting">Troubleshooting</a>
<ul>
<li><a href="#Error:_S3Guard_table_lacks_version_marker.">Error: S3Guard table lacks version marker.</a></li>
<li><a href="#Error:_Database_table_is_from_an_incompatible_S3Guard_version">Error: Database table is from an incompatible S3Guard version</a></li>
<li><a href="#Error_DynamoDB_table_TABLE_does_not_exist_in_region_REGION_auto-creation_is_turned_off">Error &quot;DynamoDB table TABLE does not exist in region REGION; auto-creation is turned off&quot;</a></li></ul></li>
<li><a href="#Error_The_level_of_configured_provisioned_throughput_for_the_table_was_exceeded">Error &quot;The level of configured provisioned throughput for the table was exceeded&quot;</a></li></ul></li>
<li><a href="#Other_Topis">Other Topis</a></li></ul>
<div class="section">
<h2><a name="Overview"></a>Overview</h2>
<p><i>S3Guard</i> is an experimental feature for the S3A client of the S3 object store, which can use a (consistent) database as the store of metadata about objects in an S3 bucket.</p>
<p>S3Guard</p>

<ol style="list-style-type: decimal">
  
<li>
<p>May improve performance on directory listing/scanning operations, including those which take place during the partitioning period of query execution, the process where files are listed and the work divided up amongst processes.</p></li>
  
<li>
<p>Permits a consistent view of the object store. Without this, changes in objects may not be immediately visible, especially in listing operations.</p></li>
  
<li>
<p>Offers a platform for future performance improvements for running Hadoop workloads on top of object stores</p></li>
</ol>
<p>The basic idea is that, for each operation in the Hadoop S3 client (s3a) that reads or modifies metadata, a shadow copy of that metadata is stored in a separate MetadataStore implementation. Each MetadataStore implementation offers HDFS-like consistency for the metadata, and may also provide faster lookups for things like file status or directory listings.</p>
<p>For links to early design documents and related patches, see <a class="externalLink" href="https://issues.apache.org/jira/browse/HADOOP-13345">HADOOP-13345</a>.</p>
<p><i>Important</i></p>

<ul>
  
<li>
<p>S3Guard is experimental and should be considered unstable.</p></li>
  
<li>
<p>While all underlying data is persisted in S3, if, for some reason, the S3Guard-cached metadata becomes inconsistent with that in S3, queries on the data may become incorrect. For example, new datasets may be omitted, objects may be overwritten, or clients may not be aware that some data has been deleted. It is essential for all clients writing to an S3Guard-enabled S3 Repository to use the feature. Clients reading the data may work directly with the S3A data, in which case the normal S3 consistency guarantees apply.</p></li>
</ul></div>
<div class="section">
<h2><a name="Setting_up_S3Guard"></a>Setting up S3Guard</h2>
<p>The latest configuration parameters are defined in <tt>core-default.xml</tt>. You should consult that file for full information, but a summary is provided here.</p>
<div class="section">
<h3><a name="a1._Choose_the_Database"></a>1. Choose the Database</h3>
<p>A core concept of S3Guard is that the directory listing data of the object store, <i>the metadata</i> is replicated in a higher-performance, consistent, database. In S3Guard, this database is called <i>The Metadata Store</i></p>
<p>By default, S3Guard is not enabled.</p>
<p>The Metadata Store to use in production is bonded to Amazon&#x2019;s DynamoDB database service. The following setting will enable this Metadata Store:</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
    &lt;name&gt;fs.s3a.metadatastore.impl&lt;/name&gt;
    &lt;value&gt;org.apache.hadoop.fs.s3a.s3guard.DynamoDBMetadataStore&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>Note that the <tt>NullMetadataStore</tt> store can be explicitly requested if desired. This offers no metadata storage, and effectively disables S3Guard.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
    &lt;name&gt;fs.s3a.metadatastore.impl&lt;/name&gt;
    &lt;value&gt;org.apache.hadoop.fs.s3a.s3guard.NullMetadataStore&lt;/value&gt;
&lt;/property&gt;
</pre></div></div></div>
<div class="section">
<h3><a name="a2._Configure_S3Guard_Settings"></a>2. Configure S3Guard Settings</h3>
<p>More settings will may be added in the future. Currently the only Metadata Store-independent setting, besides the implementation class above, is the <i>allow authoritative</i> flag.</p>
<p>It is recommended that you leave the default setting here:</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
    &lt;name&gt;fs.s3a.metadatastore.authoritative&lt;/name&gt;
    &lt;value&gt;false&lt;/value&gt;
&lt;/property&gt;

</pre></div></div>
<p>Setting this to <tt>true</tt> is currently an experimental feature. When true, the S3A client will avoid round-trips to S3 when getting directory listings, if there is a fully-cached version of the directory stored in the Metadata Store.</p>
<p>Note that if this is set to true, it may exacerbate or persist existing race conditions around multiple concurrent modifications and listings of a given directory tree.</p>
<p>In particular: <b>If the Metadata Store is declared as authoritative, all interactions with the S3 bucket(s) must be through S3A clients sharing the same Metadata Store</b></p></div>
<div class="section">
<h3><a name="a3._Configure_the_Metadata_Store."></a>3. Configure the Metadata Store.</h3>
<p>Here are the <tt>DynamoDBMetadataStore</tt> settings. Other Metadata Store implementations will have their own configuration parameters.</p></div>
<div class="section">
<h3><a name="a4._Name_Your_Table"></a>4. Name Your Table</h3>
<p>First, choose the name of the table you wish to use for the S3Guard metadata storage in your DynamoDB instance. If you leave it unset/empty, a separate table will be created for each S3 bucket you access, and that bucket&#x2019;s name will be used for the name of the DynamoDB table. For example, this sets the table name to <tt>my-ddb-table-name</tt></p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.s3guard.ddb.table&lt;/name&gt;
  &lt;value&gt;my-ddb-table-name&lt;/value&gt;
  &lt;description&gt;
    The DynamoDB table name to operate. Without this property, the respective
    S3 bucket names will be used.
  &lt;/description&gt;
&lt;/property&gt;
</pre></div></div>
<p>It is good to share a table across multiple buckets for multiple reasons.</p>

<ol style="list-style-type: decimal">
  
<li>
<p>You are billed for the I/O capacity allocated to the table, <i>even when the table is not used</i>. Sharing capacity can reduce costs.</p></li>
  
<li>
<p>You can share the &#x201c;provision burden&#x201d; across the buckets. That is, rather than allocating for the peak load on a single bucket, you can allocate for the peak load <i>across all the buckets</i>, which is likely to be significantly lower.</p></li>
  
<li>
<p>It&#x2019;s easier to measure and tune the load requirements and cost of S3Guard, because there is only one table to review and configure in the AWS management console.</p></li>
</ol>
<p>When wouldn&#x2019;t you want to share a table?</p>

<ol style="list-style-type: decimal">
  
<li>
<p>When you do explicitly want to provision I/O capacity to a specific bucket and table, isolated from others.</p></li>
  
<li>
<p>When you are using separate billing for specific buckets allocated to specific projects.</p></li>
  
<li>
<p>When different users/roles have different access rights to different buckets. As S3Guard requires all users to have R/W access to the table, all users will be able to list the metadata in all buckets, even those to which they lack read access.</p></li>
</ol></div>
<div class="section">
<h3><a name="a5._Locate_your_Table"></a>5. Locate your Table</h3>
<p>You may also wish to specify the region to use for DynamoDB. If a region is not configured, S3A will assume that it is in the same region as the S3 bucket. A list of regions for the DynamoDB service can be found in <a class="externalLink" href="http://docs.aws.amazon.com/general/latest/gr/rande.html#ddb_region">Amazon&#x2019;s documentation</a>. In this example, to use the US West 2 region:</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.s3guard.ddb.region&lt;/name&gt;
  &lt;value&gt;us-west-2&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>When working with S3Guard-managed buckets from EC2 VMs running in AWS infrastructure, using a local DynamoDB region ensures the lowest latency and highest reliability, as well as avoiding all long-haul network charges. The S3Guard tables, and indeed, the S3 buckets, should all be in the same region as the VMs.</p></div>
<div class="section">
<h3><a name="a6._Optional:_Create_your_Table"></a>6. Optional: Create your Table</h3>
<p>Next, you can choose whether or not the table will be automatically created (if it doesn&#x2019;t already exist). If you want this feature, set the <tt>fs.s3a.s3guard.ddb.table.create</tt> option to <tt>true</tt>.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.s3guard.ddb.table.create&lt;/name&gt;
  &lt;value&gt;true&lt;/value&gt;
  &lt;description&gt;
    If true, the S3A client will create the table if it does not already exist.
  &lt;/description&gt;
&lt;/property&gt;
</pre></div></div></div>
<div class="section">
<h3><a name="a7._If_creating_a_table:_Set_your_DynamoDB_IO_Capacity"></a>7. If creating a table: Set your DynamoDB IO Capacity</h3>
<p>Next, you need to set the DynamoDB read and write throughput requirements you expect to need for your cluster. Setting higher values will cost you more money. <i>Note</i> that these settings only affect table creation when <tt>fs.s3a.s3guard.ddb.table.create</tt> is enabled. To change the throughput for an existing table, use the AWS console or CLI tool.</p>
<p>For more details on DynamoDB capacity units, see the AWS page on <a class="externalLink" href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/WorkingWithTables.html#CapacityUnitCalculations">Capacity Unit Calculations</a>.</p>
<p>The charges are incurred per hour for the life of the table, <i>even when the table and the underlying S3 buckets are not being used</i>.</p>
<p>There are also charges incurred for data storage and for data IO outside of the region of the DynamoDB instance. S3Guard only stores metadata in DynamoDB: path names and summary details of objects &#x2014;the actual data is stored in S3, so billed at S3 rates.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.s3guard.ddb.table.capacity.read&lt;/name&gt;
  &lt;value&gt;500&lt;/value&gt;
  &lt;description&gt;
    Provisioned throughput requirements for read operations in terms of capacity
    units for the DynamoDB table.  This config value will only be used when
    creating a new DynamoDB table, though later you can manually provision by
    increasing or decreasing read capacity as needed for existing tables.
    See DynamoDB documents for more information.
  &lt;/description&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;fs.s3a.s3guard.ddb.table.capacity.write&lt;/name&gt;
  &lt;value&gt;100&lt;/value&gt;
  &lt;description&gt;
    Provisioned throughput requirements for write operations in terms of
    capacity units for the DynamoDB table.  Refer to related config
    fs.s3a.s3guard.ddb.table.capacity.read before usage.
  &lt;/description&gt;
&lt;/property&gt;
</pre></div></div>
<p>Attempting to perform more IO than the capacity requested simply throttles the IO; small capacity numbers are recommended when initially experimenting with S3Guard.</p></div></div>
<div class="section">
<h2><a name="Authenticating_with_S3Guard"></a>Authenticating with S3Guard</h2>
<p>The DynamoDB metadata store takes advantage of the fact that the DynamoDB service uses the same authentication mechanisms as S3. S3Guard gets all its credentials from the S3A client that is using it.</p>
<p>All existing S3 authentication mechanisms can be used, except for one exception. Credentials placed in URIs are not supported for S3Guard, for security reasons.</p></div>
<div class="section">
<h2><a name="Per-bucket_S3Guard_configuration"></a>Per-bucket S3Guard configuration</h2>
<p>In production, it is likely only some buckets will have S3Guard enabled; those which are read-only may have disabled, for example. Equally importantly, buckets in different regions should have different tables, each in the relevant region.</p>
<p>These options can be managed through S3A&#x2019;s <a href="./index.html#Configuring_different_S3_buckets">per-bucket configuration mechanism</a>. All options with the under <tt>fs.s3a.bucket.BUCKETNAME.KEY</tt> are propagated to the options <tt>fs.s3a.KEY</tt> <i>for that bucket only</i>.</p>
<p>As an example, here is a configuration to use different metadata stores and tables for different buckets</p>
<p>First, we define shortcuts for the metadata store classnames</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;s3guard.null&lt;/name&gt;
  &lt;value&gt;org.apache.hadoop.fs.s3a.s3guard.NullMetadataStore&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;s3guard.dynamo&lt;/name&gt;
  &lt;value&gt;org.apache.hadoop.fs.s3a.s3guard.DynamoDBMetadataStore&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>Next, Amazon&#x2019;s public landsat database is configured with no metadata store</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.bucket.landsat-pds.metadatastore.impl&lt;/name&gt;
  &lt;value&gt;${s3guard.null}&lt;/value&gt;
  &lt;description&gt;The read-only landsat-pds repository isn't
  managed by S3Guard&lt;/description&gt;
&lt;/property&gt;
</pre></div></div>
<p>Next the <tt>ireland-2</tt> and <tt>ireland-offline</tt> buckets are configured with DynamoDB as the store, and a shared table <tt>production-table</tt></p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.bucket.ireland-2.metadatastore.impl&lt;/name&gt;
  &lt;value&gt;${s3guard.dynamo}&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;fs.s3a.bucket.ireland-offline.metadatastore.impl&lt;/name&gt;
  &lt;value&gt;${s3guard.dynamo}&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;fs.s3a.bucket.ireland-2.s3guard.ddb.table&lt;/name&gt;
  &lt;value&gt;production-table&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
<p>The region of this table is automatically set to be that of the buckets, here <tt>eu-west-1</tt>; the same table name may actually be used in different regions.</p>
<p>Together then, this configuration enables the DynamoDB Metadata Store for two buckets with a shared table, while disabling it for the public bucket.</p></div>
<div class="section">
<h2><a name="S3Guard_Command_Line_Interface_CLI"></a>S3Guard Command Line Interface (CLI)</h2>
<p>Note that in some cases an AWS region or <tt>s3a://</tt> URI can be provided.</p>
<p>Metadata store URIs include a scheme that designates the backing store. For example (e.g. <tt>dynamodb://table_name</tt>;). As documented above, the AWS region can be inferred if the URI to an existing bucket is provided.</p>
<p>The S3A URI must also be provided for per-bucket configuration options to be picked up. That is: when an s3a URL is provided on the command line, all its &#x201c;resolved&#x201d; per-bucket settings are used to connect to, authenticate with and configure the S3Guard table. If no such URL is provided, then the base settings are picked up.</p>
<div class="section">
<h3><a name="Create_a_table:_s3guard_init"></a>Create a table: <tt>s3guard init</tt></h3>

<div class="source">
<div class="source">
<pre>hadoop s3guard init -meta URI ( -region REGION | s3a://BUCKET )
</pre></div></div>
<p>Creates and initializes an empty metadata store.</p>
<p>A DynamoDB metadata store can be initialized with additional parameters pertaining to <a class="externalLink" href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.ProvisionedThroughput.html">Provisioned Throughput</a>:</p>

<div class="source">
<div class="source">
<pre>[-write PROVISIONED_WRITES] [-read PROVISIONED_READS]
</pre></div></div>
<p>Example 1</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard init -meta dynamodb://ireland-team -write 5 -read 10 s3a://ireland-1
</pre></div></div>
<p>Creates a table &#x201c;ireland-team&#x201d; with a capacity of 5 for writes, 10 for reads, in the same location as the bucket &#x201c;ireland-1&#x201d;.</p>
<p>Example 2</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard init -meta dynamodb://ireland-team -region eu-west-1
</pre></div></div>
<p>Creates a table &#x201c;ireland-team&#x201d; in the region &#x201c;eu-west-1.amazonaws.com&#x201d;</p></div>
<div class="section">
<h3><a name="Import_a_bucket:_s3guard_import"></a>Import a bucket: <tt>s3guard import</tt></h3>

<div class="source">
<div class="source">
<pre>hadoop s3guard import [-meta URI] s3a://BUCKET
</pre></div></div>
<p>Pre-populates a metadata store according to the current contents of an S3 bucket. If the <tt>-meta</tt> option is omitted, the binding information is taken from the <tt>core-site.xml</tt> configuration.</p>
<p>Example</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard import s3a://ireland-1
</pre></div></div></div>
<div class="section">
<h3><a name="Audit_a_table:_s3guard_diff"></a>Audit a table: <tt>s3guard diff</tt></h3>

<div class="source">
<div class="source">
<pre>hadoop s3guard diff [-meta URI] s3a://BUCKET
</pre></div></div>
<p>Lists discrepancies between a metadata store and bucket. Note that depending on how S3Guard is used, certain discrepancies are to be expected.</p>
<p>Example</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard diff s3a://ireland-1
</pre></div></div></div>
<div class="section">
<h3><a name="Display_information_about_a_bucket_s3guard_bucket-info"></a>Display information about a bucket, <tt>s3guard bucket-info</tt></h3>
<p>Prints and optionally checks the s3guard and encryption status of a bucket.</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard bucket-info [ -guarded ] [-unguarded] [-auth] [-nonauth] [-encryption ENCRYPTION] s3a://BUCKET
</pre></div></div>
<p>Options</p>

<table border="0" class="bodyTable">
  <thead>
    
<tr class="a">
      
<th>argument </th>
      
<th>meaning </th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td><tt>-guarded</tt> </td>
      
<td>Require S3Guard to be enabled </td>
    </tr>
    
<tr class="a">
      
<td><tt>-unguarded</tt> </td>
      
<td>Require S3Guard to be disabled </td>
    </tr>
    
<tr class="b">
      
<td><tt>-auth</tt> </td>
      
<td>Require the S3Guard mode to be &#x201c;authoritative&#x201d; </td>
    </tr>
    
<tr class="a">
      
<td><tt>-nonauth</tt> </td>
      
<td>Require the S3Guard mode to be &#x201c;non-authoritative&#x201d; </td>
    </tr>
    
<tr class="b">
      
<td><tt>-encryption &lt;type&gt;</tt> </td>
      
<td>Require a specific server-side encryption algorithm </td>
    </tr>
  </tbody>
</table>
<p>The server side encryption options are not directly related to S3Guard, but it is often convenient to check them at the same time.</p>
<p>Example</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard bucket-info -guarded s3a://ireland-1
</pre></div></div>
<p>List the details of bucket <tt>s3a://ireland-1</tt>, mandating that it must have S3Guard enabled</p>

<div class="source">
<div class="source">
<pre>Filesystem s3a://ireland-1
Location: eu-west-1
Filesystem s3a://ireland-1 is using S3Guard with store DynamoDBMetadataStore{region=eu-west-1, tableName=ireland-1}
Authoritative S3Guard: fs.s3a.metadatastore.authoritative=false
Metadata Store Diagnostics:
  ARN=arn:aws:dynamodb:eu-west-1:00000000:table/ireland-1
  description=S3Guard metadata store in DynamoDB
  name=ireland-1
  read-capacity=20
  region=eu-west-1
  retryPolicy=ExponentialBackoffRetry(maxRetries=9, sleepTime=100 MILLISECONDS)
  size=12812
  status=ACTIVE
  table={AttributeDefinitions: [{AttributeName: child,AttributeType: S},
    {AttributeName: parent,AttributeType: S}],TableName: ireland-1,
    KeySchema: [{AttributeName: parent,KeyType: HASH}, {AttributeName: child,KeyType: RANGE}],
    TableStatus: ACTIVE,
    CreationDateTime: Fri Aug 25 19:07:25 BST 2017,
    ProvisionedThroughput: {LastIncreaseDateTime: Tue Aug 29 11:45:18 BST 2017,
    LastDecreaseDateTime: Wed Aug 30 15:37:51 BST 2017,
    NumberOfDecreasesToday: 1,
    ReadCapacityUnits: 20,WriteCapacityUnits: 20},
    TableSizeBytes: 12812,ItemCount: 91,
    TableArn: arn:aws:dynamodb:eu-west-1:00000000:table/ireland-1,}
  write-capacity=20

S3A Client
  Endpoint: fs.s3a.endpoint=s3-eu-west-1.amazonaws.com
  Encryption: fs.s3a.server-side-encryption-algorithm=none
  Input seek policy: fs.s3a.experimental.input.fadvise=normal
</pre></div></div>
<p>This listing includes all the information about the table supplied from</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard bucket-info -unguarded -encryption none s3a://landsat-pds
</pre></div></div>
<p>List the S3Guard status of clients of the public <tt>landsat-pds</tt> bucket, and verifies that the data is neither tracked with S3Guard nor encrypted.</p>

<div class="source">
<div class="source">
<pre>Filesystem s3a://landsat-pdsLocation: us-west-2
Filesystem s3a://landsat-pds is not using S3Guard
Endpoint: fs.s3a.endpoints3.amazonaws.com
Encryption: fs.s3a.server-side-encryption-algorithm=none
Input seek policy: fs.s3a.experimental.input.fadvise=normal
</pre></div></div>
<p>Note that other clients may have a S3Guard table set up to store metadata on this bucket; the checks are all done from the perspective of the configuration setttings of the current client.</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard bucket-info -guarded -auth s3a://landsat-pds
</pre></div></div>
<p>Require the bucket to be using S3Guard in authoritative mode. This will normally fail against this specific bucket.</p></div>
<div class="section">
<h3><a name="Delete_a_table:_s3guard_destroy"></a>Delete a table: <tt>s3guard destroy</tt></h3>
<p>Deletes a metadata store. With DynamoDB as the store, this means the specific DynamoDB table use to store the metadata.</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard destroy [-meta URI] ( -region REGION | s3a://BUCKET )
</pre></div></div>
<p>This <i>does not</i> delete the bucket, only the S3Guard table which it is bound to.</p>
<p>Examples</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard destroy s3a://ireland-1
</pre></div></div>
<p>Deletes the table which the bucket ireland-1 is configured to use as its MetadataStore.</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard destroy -meta dynamodb://ireland-team -region eu-west-1
</pre></div></div></div>
<div class="section">
<h3><a name="Clean_up_a_table_s3guard_prune"></a>Clean up a table, <tt>s3guard prune</tt></h3>
<p>Delete all file entries in the MetadataStore table whose object &#x201c;modification time&#x201d; is older than the specified age.</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard prune [-days DAYS] [-hours HOURS] [-minutes MINUTES]
    [-seconds SECONDS] [-m URI] ( -region REGION | s3a://BUCKET )
</pre></div></div>
<p>A time value of hours, minutes and/or seconds must be supplied.</p>

<ol style="list-style-type: decimal">
  
<li>This does not delete the entries in the bucket itself.</li>
  
<li>The modification time is effectively the creation time of the objects in the S3 Bucket.</li>
  
<li>Even when an S3A URI is supplied, all entries in the table older than a specific age are deleted &#x2014; even those from other buckets.</li>
</ol>
<p>Example</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard prune -days 7 s3a://ireland-1
</pre></div></div>
<p>Deletes all entries in the S3Guard table for files older than seven days from the table associated with <tt>s3a://ireland-1</tt>.</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard prune -hours 1 -minutes 30 -meta dynamodb://ireland-team -region eu-west-1
</pre></div></div>
<p>Delete all entries more than 90 minutes old from the table &#x201c;ireland-team&#x201d; in the region &#x201c;eu-west-1&#x201d;.</p></div>
<div class="section">
<h3><a name="Tune_the_IO_capacity_of_the_DynamoDB_Table_s3guard_set-capacity"></a>Tune the IO capacity of the DynamoDB Table, <tt>s3guard set-capacity</tt></h3>
<p>Alter the read and/or write capacity of a s3guard table.</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard set-capacity [--read UNIT] [--write UNIT] ( -region REGION | s3a://BUCKET )
</pre></div></div>
<p>The <tt>--read</tt> and <tt>--write</tt> units are those of <tt>s3guard init</tt>.</p>
<p>Example</p>

<div class="source">
<div class="source">
<pre>hadoop s3guard set-capacity  -read 20 -write 20 s3a://ireland-1
</pre></div></div>
<p>Set the capacity of the table used by bucket <tt>s3a://ireland-1</tt> to 20 read and 20 write. (This is a low number, incidentally)</p>

<div class="source">
<div class="source">
<pre>2017-08-30 16:21:26,343 [main] INFO  s3guard.S3GuardTool (S3GuardTool.java:initMetadataStore(229)) - Metadata store DynamoDBMetadataStore{region=eu-west-1, tableName=ireland-1} is initialized.
2017-08-30 16:21:26,344 [main] INFO  s3guard.DynamoDBMetadataStore (DynamoDBMetadataStore.java:updateParameters(1084)) - Current table capacity is read: 25, write: 25
2017-08-30 16:21:26,344 [main] INFO  s3guard.DynamoDBMetadataStore (DynamoDBMetadataStore.java:updateParameters(1086)) - Changing capacity of table to read: 20, write: 20
Metadata Store Diagnostics:
  ARN=arn:aws:dynamodb:eu-west-1:00000000000:table/ireland-1
  description=S3Guard metadata store in DynamoDB
  name=ireland-1
  read-capacity=25
  region=eu-west-1
  retryPolicy=ExponentialBackoffRetry(maxRetries=9, sleepTime=100 MILLISECONDS)
  size=12812
  status=UPDATING
  table={ ... }
  write-capacity=25
</pre></div></div>
<p>After the update, the table status changes to <tt>UPDATING</tt>; this is a sign that the capacity has been changed</p>
<p>Repeating the same command will not change the capacity, as both read and write values match that already in use</p>

<div class="source">
<div class="source">
<pre>2017-08-30 16:24:35,337 [main] INFO  s3guard.DynamoDBMetadataStore (DynamoDBMetadataStore.java:updateParameters(1090)) - Table capacity unchanged at read: 20, write: 20
Metadata Store Diagnostics:
  ARN=arn:aws:dynamodb:eu-west-1:00000000000:table/ireland-1
  description=S3Guard metadata store in DynamoDB
  name=ireland-1
  read-capacity=20
  region=eu-west-1
  retryPolicy=ExponentialBackoffRetry(maxRetries=9, sleepTime=100 MILLISECONDS)
  size=12812
  status=ACTIVE
  table={ ... }
  write-capacity=20
</pre></div></div></div></div>
<div class="section">
<h2><a name="Debugging_and_Error_Handling"></a>Debugging and Error Handling</h2>
<p>If you run into network connectivity issues, or have a machine failure in the middle of an operation, you may end up with your metadata store having state that differs from S3. The S3Guard CLI commands, covered in the CLI section above, can be used to diagnose and repair these issues.</p>
<p>There are some logs whose log level can be increased to provide more information.</p>

<div class="source">
<div class="source">
<pre># Log S3Guard classes
log4j.logger.org.apache.hadoop.fs.s3a.s3guard=DEBUG

# Log all S3A classes
log4j.logger.org.apache.hadoop.fs.s3a=DEBUG

# Enable debug logging of AWS DynamoDB client
log4j.logger.com.amazonaws.services.dynamodbv2.AmazonDynamoDB

# Log all HTTP requests made; includes S3 interaction. This may
# include sensitive information such as account IDs in HTTP headers.
log4j.logger.com.amazonaws.request=DEBUG

</pre></div></div>
<p>If all else fails, S3Guard is designed to allow for easy recovery by deleting the metadata store data. In DynamoDB, this can be accomplished by simply deleting the table, and allowing S3Guard to recreate it from scratch. Note that S3Guard tracks recent changes to file metadata to implement consistency. Deleting the metadata store table will simply result in a period of eventual consistency for any file modifications that were made right before the table was deleted.</p>
<div class="section">
<h3><a name="Failure_Semantics"></a>Failure Semantics</h3>
<p>Operations which modify metadata will make changes to S3 first. If, and only if, those operations succeed, the equivalent changes will be made to the Metadata Store.</p>
<p>These changes to S3 and Metadata Store are not fully-transactional: If the S3 operations succeed, and the subsequent Metadata Store updates fail, the S3 changes will <i>not</i> be rolled back. In this case, an error message will be logged.</p></div>
<div class="section">
<h3><a name="Versioning"></a>Versioning</h3>
<p>S3Guard tables are created with a version marker, an entry with the primary key and child entry of <tt>../VERSION</tt>; the use of a relative path guarantees that it will not be resolved.</p>
<div class="section">
<h4><a name="Versioning_policy."></a>Versioning policy.</h4>

<ol style="list-style-type: decimal">
  
<li>The version number of an S3Guard table will only be incremented when an incompatible change is made to the table structure &#x2014;that is, the structure has changed so that it is no longer readable by older versions, or because it has added new mandatory fields which older versions do not create.</li>
  
<li>The version number of S3Guard tables will only be changed by incrementing the value.</li>
  
<li>Updated versions of S3Guard MAY continue to support older version tables.</li>
  
<li>If an incompatible change is made such that existing tables are not compatible, then a means shall be provided to update existing tables. For example: an option in the Command Line Interface, or an option to upgrade tables during S3Guard initialization.</li>
</ol>
<p><i>Note</i>: this policy does not indicate any intent to upgrade table structures in an incompatible manner. The version marker in tables exists to support such an option if it ever becomes necessary, by ensuring that all S3Guard client can recognise any version mismatch.</p></div></div>
<div class="section">
<h3><a name="Security"></a>Security</h3>
<p>All users of the DynamoDB table must have write access to it. This effectively means they must have write access to the entire object store.</p>
<p>There&#x2019;s not been much testing of using a S3Guard Metadata Store with a read-only S3 Bucket. It <i>should</i> work, provided all users have write access to the DynamoDB table. And, as updates to the Metadata Store are only made after successful file creation, deletion and rename, the store is <i>unlikely</i> to get out of sync, it is still something which merits more testing before it could be considered reliable.</p></div>
<div class="section">
<h3><a name="Troubleshooting"></a>Troubleshooting</h3>
<div class="section">
<h4><a name="Error:_S3Guard_table_lacks_version_marker."></a>Error: <tt>S3Guard table lacks version marker.</tt></h4>
<p>The table which was intended to be used as a S3guard metadata store does not have any version marker indicating that it is a S3Guard table.</p>
<p>It may be that this is not a S3Guard table.</p>

<ul>
  
<li>Make sure that this is the correct table name.</li>
  
<li>Delete the table, so it can be rebuilt.</li>
</ul></div>
<div class="section">
<h4><a name="Error:_Database_table_is_from_an_incompatible_S3Guard_version"></a>Error: <tt>Database table is from an incompatible S3Guard version</tt></h4>
<p>This indicates that the version of S3Guard which created (or possibly updated) the database table is from a different version that that expected by the S3A client.</p>
<p>This error will also include the expected and actual version numbers.</p>
<p>If the expected version is lower than the actual version, then the version of the S3A client library is too old to interact with this S3Guard-managed bucket. Upgrade the application/library.</p>
<p>If the expected version is higher than the actual version, then the table itself will need upgrading.</p></div>
<div class="section">
<h4><a name="Error_DynamoDB_table_TABLE_does_not_exist_in_region_REGION_auto-creation_is_turned_off"></a>Error <tt>&quot;DynamoDB table TABLE does not exist in region REGION; auto-creation is turned off&quot;</tt></h4>
<p>S3Guard could not find the DynamoDB table for the Metadata Store, and it was not configured to create it. Either the table was missing, or the configuration is preventing S3Guard from finding the table.</p>

<ol style="list-style-type: decimal">
  
<li>Verify that the value of <tt>fs.s3a.s3guard.ddb.table</tt> is correct.</li>
  
<li>If the region for an existing table has been set in <tt>fs.s3a.s3guard.ddb.region</tt>, verify that the value is correct.</li>
  
<li>If the region is not set, verify that the table exists in the same region as the bucket being used.</li>
  
<li>Create the table if necessary.</li>
</ol></div></div>
<div class="section">
<h3><a name="Error_The_level_of_configured_provisioned_throughput_for_the_table_was_exceeded"></a>Error <tt>&quot;The level of configured provisioned throughput for the table was exceeded&quot;</tt></h3>
<p>The IO load of clients of the (shared) DynamoDB table was exceeded.</p>
<p>Currently S3Guard doesn&#x2019;t do any throttling and retries here; the way to address this is to increase capacity via the AWS console or the <tt>set-capacity</tt> command.</p></div></div>
<div class="section">
<h2><a name="Other_Topis"></a>Other Topis</h2>
<p>For details on how to test S3Guard, see <a href="./testing.html#s3guard">Testing S3Guard</a></p></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        &#169;            2018
              Apache Software Foundation
            
                          - <a href="http://maven.apache.org/privacy-policy.html">Privacy Policy</a>.
        Apache Maven, Maven, Apache, the Apache feather logo, and the Apache Maven project logos are trademarks of The Apache Software Foundation.
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
