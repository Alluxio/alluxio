#!/usr/bin/env bash

function printUsage {
  echo "Usage: tachyon-perf <TestCase>"
  echo "now TestCase is one of:"
  echo -e "  SimpleWrite SimpleRead SkipRead Metadata Mixture Iterate Massive"
  echo "the detailed configurations are in conf/testsuite/"
}

# if less than 1 args specified, show usage
if [ $# -le 0 ]; then
  printUsage
  exit 1
fi

bin=`cd "$( dirname "$0" )"; pwd`

DEFAULT_PERF_LIBEXEC_DIR="$bin"/../libexec
TACHYON_PERF_LIBEXEC_DIR=${TACHYON_PERF_LIBEXEC_DIR:-$DEFAULT_PERF_LIBEXEC_DIR}
. $TACHYON_PERF_LIBEXEC_DIR/tachyon-perf-config.sh

NODELIST=$TACHYON_PERF_CONF_DIR/slaves

taskid=0
SLAVES=`sort "$NODELIST"|sed  "s/#.*$//;/^$/d"`
TOTAL_TASKS=`echo $SLAVES | wc -w`
UNIQ_SLAVES=`sort "$NODELIST" | uniq | sed  "s/#.*$//;/^$/d"`
if [ $TACHYON_PERF_SHARED_FS = "true" ]; then
  echo "Installed on a Shared File System, no configuration copy needed"
else
  for slave in $UNIQ_SLAVES; do
    echo -n "Copy configurations to $slave... "
    scp $TACHYON_PERF_CONF_DIR/tachyon-perf-env.sh $slave:$TACHYON_PERF_CONF_DIR/tachyon-perf-env.sh
    scp $TACHYON_PERF_CONF_DIR/testsuite/$1.xml $slave:$TACHYON_PERF_CONF_DIR/testsuite/$1.xml
    sleep 0.02
  done
  wait
fi

for slave in $UNIQ_SLAVES; do
  slavenum=`echo $SLAVES | grep -o "$slave" | wc -l`
  lasttaskid=`expr $taskid + $slavenum - 1`
  echo -n "Connect to $slave... "
  ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -t $slave $bin/tachyon-perf-start.sh $slave $taskid $lasttaskid $TOTAL_TASKS $1 2>&1
  sleep 0.02
  taskid=`expr $lasttaskid + 1`
done
wait

$JAVA -cp $TACHYON_PERF_CONF_DIR/:$TACHYON_PERF_JAR -Dtachyon.perf.home=$TACHYON_PERF_HOME -Dtachyon.perf.logger.type="PERF_MASTER_LOGGER" -Dtachyon.perf.slave.id="" -Dlog4j.configuration=file:$TACHYON_PERF_CONF_DIR/log4j.properties $TACHYON_JAVA_OPTS $TACHYON_PERF_JAVA_OPTS tachyon.perf.TachyonPerfMaster $TOTAL_TASKS $SLAVES $1
