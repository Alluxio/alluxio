#!/usr/bin/env bash

function printUsage {
  echo "Usage: tachyon-perf-batch <TestCase> <Clean|NoClean> <XmlsDir>"
  echo -e "  The TestCase is the same as ./tachyon-perf"
  echo -e "  Clean means to clean the workspace after each test, while NoClean means not to clean"
  echo -e "  XmlsDir is the directory of the xml conf files"
}

# if less than 3 args specified, show usage
if [ $# -le 2 ]; then
  printUsage
  exit 1
fi

bin=`cd "$( dirname "$0" )"; pwd`

DEFAULT_PERF_LIBEXEC_DIR="$bin"/../libexec
TACHYON_PERF_LIBEXEC_DIR=${TACHYON_PERF_LIBEXEC_DIR:-$DEFAULT_PERF_LIBEXEC_DIR}
. $TACHYON_PERF_LIBEXEC_DIR/tachyon-perf-config.sh

for file in `ls $3/*.xml`; do
  filename=${file##*/}
  echo "$1 Test with $filename"
  cp $file $bin/../conf/testsuite/$1.xml
  $bin/tachyon-perf $1
  $bin/tachyon-perf-collect $1
  resultfile=$TACHYON_PERF_OUT_DIR/TachyonPerfReport-$1-${filename%.*}
  echo "mv report to $resultfile"
  mv $TACHYON_PERF_OUT_DIR/TachyonPerfReport-$1 $resultfile
  sleep 2
  if [ $2 = "Clean" ]; then
    $bin/tachyon-perf-clean
    sleep 2
  fi
done

