#
# The Alluxio Open Foundation licenses this work under the Apache License, version 2.0
# (the "License"). You may not use this work except in compliance with the License, which is
# available at www.apache.org/licenses/LICENSE-2.0
#
# This software is distributed on an "AS IS" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
# either express or implied, as more fully set forth in the License.
#
# See the NOTICE file distributed with this work for information regarding copyright ownership.
#

apiVersion: batch/v1
kind: Job
metadata:
  name: alluxio-format-master
spec:
  activeDeadlineSeconds: {{ .Values.job.activeDeadlineSeconds }}
  ttlSecondsAfterFinished: {{ .Values.job.ttlSecondsAfterFinished }}
  template:
    spec:
      containers:
        - name: alluxio-master
          image: {{ .Values.image }}:{{ .Values.imageTag }}
          imagePullPolicy: {{ .Values.imagePullPolicy }}
          resources:
            limits:
              cpu: {{ .Values.resources.master.limits.cpu }}
              memory: {{ .Values.resources.master.limits.memory }}
            requests:
              cpu: {{ .Values.resources.master.requests.cpu }}
              memory: {{ .Values.resources.master.requests.memory }}
          command: ["/opt/alluxio/bin/alluxio"]
          args: ["format"]
          envFrom:
            - configMapRef:
                name: {{ .Values.const.configName }}
          ports:
          - containerPort: 19998
            name: rpc
          - containerPort: 19999
            name: web
          - containerPort: 19200
            name: embedded
          volumeMounts:
          - name: alluxio-journal
            mountPath: {{ .Values.journal.folder }}
      restartPolicy: OnFailure
      volumes:
        - name: alluxio-journal
          persistentVolumeClaim:
            claimName: alluxio-pv-claim
